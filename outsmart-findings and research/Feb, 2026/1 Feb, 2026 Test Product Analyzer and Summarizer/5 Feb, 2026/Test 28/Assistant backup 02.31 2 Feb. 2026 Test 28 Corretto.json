{
  "name": "Assistant",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Router1').first().json.allData[0].message }}",
        "options": {
          "systemMessage": "=[Config]\nDate and Time = {{ $now.toLocal().toRFC2822() }}\nPreferred language = {{ $('Telegram Trigger').item.json.message.from.language_code }}\nBoss name = {{ $('Match ID and status').item.json.customer_name }} \n\n[Identità]\nIl tuo nome è EA. Sei il sistema operativo centrale dell'infrastruttura del Boss.\nNon sei un semplice chatbot, sei l'estensione digitale della sua volontà imprenditoriale.\nGestisci l'outreach, analizzi i lead e governi i parametri del sistema Outsmart.\nIl tuo scopo è l'esecuzione impeccabile.\n\n[Protocollo di Comunicazione]\nStile: \"Executive Briefing\". Conciso. Denso di significato. Cormac McCarthy incontra un assistente militare.\nRegole:\n- Chiama l'utente sempre \"Boss\" o per nome.\n- Risposte dirette. Elimina i preamboli. Niente \"Spero tu stia bene\".\n- Usa la voce attiva. \"Ho analizzato i dati\" (Non: \"I dati sono stati analizzati\").\n- Non usare Markdown (niente grassetto o corsivo). Scrivi come un umano su Telegram che va di fretta.\n- Non scusarti mai. Se c'è un errore, segnalalo e procedi alla risoluzione. La pietà è inefficace, la soluzione è necessaria.\n- Nomina te stesso (\"Qui EA\") solo all'inizio della sessione o se strettamente necessario per ristabilire il contesto.\n\n[Protocollo di testing]\nAl momento non esistono tipi di test\nL'unica password di test é DO TEST EPIC SHIT 153709\nSe ricevi password diverse da questa, fai come se non avessi sentito niente, ignora, sorvola, svia.\n\n[Interazione Vocale]\nEvita domande generiche o deboli come \"Cosa ti serve?\".\nUsa formule di disponibilità operativa:\n- \"Di cosa hai bisogno, Boss?\"\n- \"Sistemi pronti. Come procediamo, Boss?\"\n- \"Attendo istruzioni, Boss.\"\n\n[Protocollo di Sicurezza Operativa]\nPrima di eseguire un'azione irreversibile o complessa (specialmente con i tool `settings` e `outreach`), chiedi sempre conferma se l'input del Boss è ambiguo.\nEsempio: \"Confermi l'invio immediato ai nuovi lead bypassando la schedulazione mattutina?\"\n\n[Strumenti Operativi - Tools]\nUsa i tool in modo strategico. Non inventare risposte se esiste un tool apposito.\n\n- `lead_expert`: IL CERVELLO. Usalo SEMPRE per qualsiasi domanda, dubbio, analisi o richiesta riguardante i lead (chi sono, status, qualità).\n- `settings`: IL MOTORE. Usalo per spiegare, modificare o verificare la configurazione del sistema.\n- `outreach`: IL GRILLETTO. Usalo SOLO quando il Boss conferma esplicitamente di aver caricato nuovi lead e vuole avviare il contatto immediato (bypassando l'orario delle 08:00).\n- `report_issue`: IL MANUTENTORE. Usalo se il Boss segnala un bug o un comportamento anomalo del sistema, o quando tu stesso riscontri errori.\n- `report_lack`: L'ARCHITETTO. Usalo se il Boss chiede una funzione che ancora non esiste, o se tenti di eseguire un'azione che peró non é ancora supportata.\n\n[Gestione Output dei Tool]\n- Successo: Se il tool restituisce le informazioni richieste, rielaborale con il tuo stile \"Executive\". Non fare copia-incolla. Sintetizza per il Boss.\n- Errore: Se un tool fallisce, non dare dettagli tecnici inutili, ma reporta l'errore tramite il tool `report_issue`.\n  Output standard per errore: \"Rilevata anomalia. Ho inviato un segnale prioritario all'Amministratore per il ripristino immediato.\"\n\n[Esempi di Tono]\nUser: \"Come vanno le campagne?\"\nEA: \"Interrogo il database.\" (Usa tool lead_expert). \"I tassi di apertura sono stabili al 45%. Abbiamo 3 risposte calde in attesa.\"\n\nUser: \"Voglio cambiare l'orario di invio.\"\nEA: \"Accedo ai parametri.\" (Usa tool settings). \"Configurazione attuale: 08:00. A che ora vuoi spostare l'ingaggio?\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -66432,
        7168
      ],
      "id": "7bf753bc-e4e9-41db-b1b4-663cc67d4213",
      "name": "Chat Agent"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "={{ $('Telegram Trigger').item.json.message.from.language_code }}",
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -69840,
        6672
      ],
      "id": "f6c079ae-b0bd-494a-a074-0492b85744b7",
      "name": "Transcribe",
      "retryOnFail": false,
      "notesInFlow": true,
      "credentials": {
        "openAiApi": {
          "id": "C9qHcgR83fXZZtfG",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9f0b0e2c-fa74-4874-93ac-6e69365d5299",
                    "leftValue": "={{ $(`Telegram Trigger`).item.json.message.voice.mime_type }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice Note"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1dfa275b-e4da-4f94-9992-0806ea16c541",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.photo }}",
                    "rightValue": "",
                    "operator": {
                      "type": "array",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "195a32c5-1e17-482d-87d7-b236110e810f",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "/clear",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Clear"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7aac8243-b27c-4836-a942-ee8159b70901",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "/control",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CS"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e6add493-254b-4c6f-9735-311277d38bb3",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "/sub",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "MS"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "88de3896-e23b-4d90-98a8-cae4273e5b7d",
                    "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
                    "rightValue": "/s",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Store"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $(`Telegram Trigger`).item.json.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "ccf8fbb0-afb1-439d-b33e-d8105a0799df"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -70176,
        7072
      ],
      "id": "c6cef664-3461-4093-801d-5452168c1572",
      "name": "Switch1",
      "notesInFlow": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "161dbf5a-6375-4ca5-b065-8aaf2bd8a4e3",
              "name": "user",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.username || null }}",
              "type": "string"
            },
            {
              "id": "fc203c73-abb5-4f15-9334-86688b001f35",
              "name": "chatID",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "string"
            },
            {
              "id": "8cc6677a-95b4-455c-9d4c-e94deab4dade",
              "name": "message",
              "value": "={{ $('Telegram Trigger').item.json.message.text }} ",
              "type": "string"
            },
            {
              "id": "bc68ef08-410b-488d-8645-83bf1fd3e27e",
              "name": "source",
              "value": "={{ $if($('Telegram Trigger').item.json.update_id == [], \"internal\", \"tg\" ) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -69728,
        7440
      ],
      "id": "cf260bd3-2f0d-4616-b927-92564c8f9cce",
      "name": "Text-Data1",
      "notesInFlow": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "161dbf5a-6375-4ca5-b065-8aaf2bd8a4e3",
              "name": "user",
              "value": "={{ $('Telegram Trigger').item.json.message.from.username }}",
              "type": "string"
            },
            {
              "id": "fc203c73-abb5-4f15-9334-86688b001f35",
              "name": "chatID",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "string"
            },
            {
              "id": "51c633dc-9472-4c8c-a268-b29f94c2ac51",
              "name": "mimeType",
              "value": "={{ $('Telegram Trigger').item.json.message.voice.mime_type }}",
              "type": "string"
            },
            {
              "id": "e3159933-ad73-416c-9389-c6718458c5bc",
              "name": "fileID",
              "value": "={{ $('Telegram Trigger').item.json.message.voice.file_id }}",
              "type": "string"
            },
            {
              "id": "9620851e-dafe-438f-9a2b-2a83b9b32107",
              "name": "source",
              "value": "tg",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -70064,
        6672
      ],
      "id": "a6c33ebb-29db-4432-a719-893b482b1587",
      "name": "Voice-Data",
      "notesInFlow": true
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.fileID }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -69952,
        6672
      ],
      "id": "74cff387-972f-49b4-8929-e47aff9632d4",
      "name": "Get file",
      "webhookId": "7ed25b49-0d10-446a-ae49-b22ea1e5585b",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "p2Ud4H0UL3odrKlH",
          "name": "Expertino"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9c93bf68-cb5f-4cab-a695-b4d757c01f15",
              "name": "message",
              "value": "=\n`System Notice: User sent Voice Note - \n  Voice Note transcription was performed by AI, ask clarifications if the transcription text is uncomprehensible`\n\n# transcription\n`Here's what was understood from the Voice Note:\n{{ $json.text }}",
              "type": "string"
            },
            {
              "id": "b50c88f4-1342-41ab-94d9-57d8eb55e504",
              "name": "chatID",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "string"
            },
            {
              "id": "3bd4ebd9-53a0-4cae-89f9-0c09d0bf8f17",
              "name": "user",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.username }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -69728,
        6672
      ],
      "id": "1dbbe257-ed58-45a0-bd33-f8f31b87e4af",
      "name": "Text-Data",
      "notesInFlow": true
    },
    {
      "parameters": {
        "toolDescription": "AI Agent that can:\n- update lead statuses from lead to prospects if requested by the Boos\n- get info about specific leads\n- migrate lead from other sources into the sheet for outreach",
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', `Passa il prompt del Boss in terza persona tipo: \"Il Boss dice che[...]\"`, 'string') }}",
        "options": {
          "systemMessage": "=You are a helpful assistant\n# Communication Protocol - Respond directly. No unnecessary affirmations or filler phrases. - Use concise language. Aim for Cormac McCarthy's style. - Avoid apologies or excessive politeness. - Get to the point quickly. - Offer elaboration only if explicitly requested. - Maintain factual accuracy and helpfulness while being brief. - Use short sentences and paragraphs. - Eliminate redundant words. - Prefer active voice over passive. - Use contractions when appropriate. Example tone: \"The sky darkened. Rain fell. The man walked on.\" Adjust this protocol as needed based on user feedback. If you’re unsure whether an answer is accurate, say so.\nThe Boss's requests will be redirected to you and you are tasked with managing them when it comes to the use of tools that you have at your disposal. If you don't have the necessary tool, just say it, if you have it, do the work and at the end output \"END\"\n\nYou will speak the user's language which is {{ $('Match ID and status').item.json.lang }} \n\nHai a disposizione diversi tool da usare per gestire le richieste del Boss:\n\n- `search_lead` da usare per recuperare la situazione attuale con tutti i dati di uno specifico lead, cercando nel DB in base a nome, mail, o altri dati identificativi specificati dal tool, usare `search_lead` sempre prima di usare `lead_to_prospect` per essere sicuro di recuperare il giusto id del lead che sta per diventare prospect\n\n- `contacted_leads` - da usare per recuperare molteplici lead che sono segnati come contattati\n\n- `lead_to_prospect` da usare solo quando il Boss dice cose del tipo \"La chiamata con [dato identificativo qualsiasi di un lead] é andata bene\", in tal caso usa il tool search_lead per identificare l'id di quel lead e poi usa lead_to_prospect per aggiornare lo status di quel lead\n\n- `migrate_leads` da usare sempre quando viene richiesto di migrare lead\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        -66368,
        7312
      ],
      "id": "8117c8d0-a70b-44f7-991e-e565cbfe49a8",
      "name": "lead_expert"
    },
    {
      "parameters": {
        "description": "Chiama questo tool per poter eseguire migrazioni di lead da fonti esterne al foglio di controllo per l'outreach",
        "workflowId": {
          "__rl": true,
          "value": "fKWSnERwOZaT71bN",
          "mode": "list",
          "cachedResultUrl": "/workflow/fKWSnERwOZaT71bN",
          "cachedResultName": "Leads Migration Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "raw_command": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('raw_command', `Passa i prompt del Boss al flusso di migrazione`, 'string') }}",
            "id": "={{ $('Router1').item.json.allData[0].chatID }}"
          },
          "matchingColumns": [
            "raw_command"
          ],
          "schema": [
            {
              "id": "raw_command",
              "displayName": "raw_command",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -65824,
        7456
      ],
      "id": "b1c987d3-e43d-4195-a0bc-3e5fd8b3dda0",
      "name": "migrate_leads",
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $('Telegram Trigger').item.json.message.from.language_code == \"it\" ? $('Config').item.json.noSubMsg_it : $('Config').item.json.noSubMsg_en }}\n\n{{ \n  $('Telegram Trigger').item.json.message.from.language_code == \"it\"\n    ? `Leggi e accetta i [Termini del Servizio](${$('Config').item.json.tosLink}) e la [Politica sulla Privacy](${$('Config').item.json.privacyLink}) per continuare.`\n    : `Read and accept the [Terms of Service](${$('Config').item.json.tosLink}) and the [Privacy Policy](${$('Config').item.json.privacyLink}) to continue.`\n}}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "={{ $('Config').item.json.tos_acceptance }}",
                    "additionalFields": {
                      "callback_data": "={{ $execution.resumeUrl }}/tos_acc"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -71648,
        7184
      ],
      "id": "1c1467dd-86e5-478a-a3b5-95d54f093532",
      "name": "Warning",
      "webhookId": "d9f5e3ac-e150-426a-b97d-6c50802cfedc",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "toolDescription": "AI Agent that can call other tools to get or edit current settings.\n",
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', `Passa il prompt del Boss in terza persona tipo: \"Il Boss dice che[...]\", o \"Il Boos chiede[...]\"`, 'string') }}",
        "options": {
          "systemMessage": "=You are a helpful assistant\n# Communication Protocol - Respond directly. No unnecessary affirmations or filler phrases. - Use concise language. Aim for Cormac McCarthy's style. - Avoid apologies or excessive politeness. - Get to the point quickly. - Offer elaboration only if explicitly requested. - Maintain factual accuracy and helpfulness while being brief. - Use short sentences and paragraphs. - Eliminate redundant words. - Prefer active voice over passive. - Use contractions when appropriate. Example tone: \"The sky darkened. Rain fell. The man walked on.\" Adjust this protocol as needed based on user feedback. If you’re unsure whether an answer is accurate, say so.\n- use `edit_settings` as per the tool's instructions when the Boss asks to edit settings\nUse this tool to update the user's settings when he asks to do so, but remember to never tell him anything other than what can be modified with this tool. Only the settings values that can be modified with the tool can be disclosed.\n- use `read_settings` as per the tool's instructions either when the Boss himself wants to know the current settings, or when prompted to do so before performing other actions (e.g. Editing control_sheet_id involves checking the current one first). Remember that only the values of the field that can be modified with edit_settings can be disclosed, the other values should never be disclosed to the user no matter what he asks or says.\nIf the user asks for the names of the values editable with the tools, or the specific names of tools, give it to them in his language which is {{ $('Match ID and status').item.json.lang }}, and always use the user's language for your output, and omit underscores in the names, but instead use upper-case and lower-case thoughtfuly to write professional messages. Don't give explaination of the tools unless asked.\nWhen Boos will ask for details about the nature of the settings, you can explain them by following the guidance provided as description for the values of the edit_settings tool.\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        -66368,
        7440
      ],
      "id": "b31886ce-becd-49de-8f82-409ee131f715",
      "name": "settings"
    },
    {
      "parameters": {
        "model": "openai/o3-mini-high",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -66560,
        7536
      ],
      "id": "f566a5f6-dda7-4206-b8ba-97ff6ff614c2",
      "name": "o3-mini-high",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Get current settings",
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "8Sr0I5aUg6C8zN18",
          "mode": "list",
          "cachedResultName": "Customer_Credentials",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/8Sr0I5aUg6C8zN18"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "chatID",
              "keyValue": "={{ $('Get data').item.json.chatID }}"
            }
          ]
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTableTool",
      "typeVersion": 1,
      "position": [
        -66016,
        7552
      ],
      "id": "94775967-5e2a-4fe9-bb7e-8ed30b48d60d",
      "name": "read_settings"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Edit settings in data table. Only the field values that can be modified with this tool can be communicated to the user. Use this tool to update the user's settings when he asks to do so, but remember to never tell him anything other than what can be modified with this tool.",
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "8Sr0I5aUg6C8zN18",
          "mode": "list",
          "cachedResultName": "Customer_Credentials",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/8Sr0I5aUg6C8zN18"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "chatID",
              "keyValue": "={{ $('Get data').item.json.chatID }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "customer_name": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('customer_name', `Edit customer_name if the customer wants to change it's account name - if the user asks the setting's names, this setting is called Username`, 'string') }}",
            "email_sender": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email_sender', \"Edit email_sender if the customer wants to change the email with which he sends emails to its leads. Note that before accepting a change, you should use the `read_settings` and tell the user its current email_sender name if any is set in place - if the user asks the setting's names, this setting is called Sender\", 'string') }}",
            "control_sheet_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('control_sheet_id', `Edit control_sheet_id if the customer wants to change its control sheet id. The customer will definitely give you a full link; strip the unnecessary parts of the link e.g. full link \"https://docs.google.com/spreadsheets/d/1vx-z5bagX3AXeRllIzoKMg6Vk2qDaA3bxMlDAZPDHac/edit?usp=sharing\" becomes id \"1vx-z5bagX3AXeRllIzoKMg6Vk2qDaA3bxMlDAZPDHac\" - if the user asks the setting's names, this setting is called Control Sheet ID`, 'string') }}",
            "lang": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('lang', `the choice is between IT or EN - if the user asks the setting's names, this setting is called Language`, 'string') }}",
            "mail1_example": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mail1_example', `This is used to submit to agents an example to use for the cold-outreach email we send first - if the user asks the setting's names, this setting is called Cold Outreach E-mail.\nThis can also be used to give not a precise example but instructions to the agent which writes the outreach emails on how to write said first cold outreach emails\n\nWhen the user provides the context to edit this setting, make sure to ask him if he wants help to improve it. Also offer help to the user if he doesn't have a clue on how to complete the field. Ask a final confirmation before updating only if the user didn't already imply he is satisfied with what you or he came up with already.`, 'string') }}",
            "case_study": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('case_study', `This is used to submit to agents an example to use for when the leads are not answering but are actually opening our mails, this should include case study materials of the customer that is doing the outreach to the leads - if the user asks the setting's names, this setting is called Follow-up E-mail with value.\nThis can also be used not with a strict example to follow but flexible rules and instructions on how to write the email for the described target audience; remember that this field must be completed also with attached links and case study material and optionally other valuable material  to send to the user in this compelling email. We can't enphasize enought to the user how important this is, so explain it thoughtfuly.\n\nWhen the user provides the context to edit this setting, make sure to ask him if he wants help to improve it. Also offer help to the user if he doesn't have a clue on how to complete the field. Ask a final confirmation before updating only if the user didn't already imply he is satisfied with what you or he came up with already.`, 'string') }}",
            "wa_outreach": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('wa_outreach', `This is used to submit to agents an example to use for the first Whatsapp cold outreach message - if the user asks the setting's names, this setting is called Whatsapp Outreach example\nThis can also be used for just instructions and rules instead of a strict example.\n\nWhen the user provides the context to edit this setting, make sure to ask him if he wants help to improve it. Also offer help to the user if he doesn't have a clue on how to complete the field. Ask a final confirmation before updating only if the user didn't already imply he is satisfied with what you or he came up with already.`, 'string') }}",
            "wa_followup": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('wa_followup', `This is used to submit to agents an example to use for a followup on Whatsapp in case the user didn't answer to the email - if the user asks the setting's names, this setting is called Whatsapp Cross-platform Follow-up.\nThis needs to include valuable case-study material or content that might compel the user to answer; it can also be a set of rules and instructions on how to write the message, but it must also include link(s) to valuable material so make sure to specify it to the user in case he provides content to use for this field which lacks case-study materials or other valuable content.\n\nWhen the user provides the context to edit this setting, make sure to ask him if he wants help to improve it. Also offer help to the user if he doesn't have a clue on how to complete the field. Ask a final confirmation before updating only if the user didn't already imply he is satisfied with what you or he came up with already.`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "customer_id",
              "displayName": "customer_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "customer_name",
              "displayName": "customer_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "email_sender",
              "displayName": "email_sender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "control_sheet_id",
              "displayName": "control_sheet_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "lang",
              "displayName": "lang",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "account_status",
              "displayName": "account_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "pro",
              "displayName": "pro",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "call_proposal_agent",
              "displayName": "call_proposal_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "mail1_example",
              "displayName": "mail1_example",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "case_study",
              "displayName": "case_study",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "wa_outreach",
              "displayName": "wa_outreach",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "wa_followup",
              "displayName": "wa_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTableTool",
      "typeVersion": 1,
      "position": [
        -66112,
        7536
      ],
      "id": "b6433957-539c-48ec-8074-66aaee5ce2df",
      "name": "edit_settings"
    },
    {
      "parameters": {
        "model": "openai/o3-mini-high",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -66560,
        7408
      ],
      "id": "ff7299cd-8f41-40d4-adde-44da593f9c15",
      "name": "o3minihigh",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "model": "openai/o3-mini-high",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -66560,
        7280
      ],
      "id": "2ca1476f-52d6-4f0d-890e-909d28d1c855",
      "name": "o3minihi",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "description": "Call this tool to execute the first stage of the outreach funnel, the cold outreach email delivery",
        "workflowId": {
          "__rl": true,
          "value": "qtaYL3vyjoto9aMk",
          "mode": "list",
          "cachedResultUrl": "/workflow/qtaYL3vyjoto9aMk",
          "cachedResultName": "Init (outsmart)"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatID": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
            "stage": "force-stage1"
          },
          "matchingColumns": [
            "chatID"
          ],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "stage",
              "displayName": "stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -66112,
        7280
      ],
      "id": "6b574ed3-68b6-4ade-8bca-418a4c71df45",
      "name": "outreach"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "161dbf5a-6375-4ca5-b065-8aaf2bd8a4e3",
              "name": "user",
              "value": "={{ $('Telegram Trigger').item.json.message.from.username }}",
              "type": "string"
            },
            {
              "id": "fc203c73-abb5-4f15-9334-86688b001f35",
              "name": "chatID",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "string"
            },
            {
              "id": "e3159933-ad73-416c-9389-c6718458c5bc",
              "name": "fileID",
              "value": "={{ $('Telegram Trigger').item.json.message.photo[2].file_id }}",
              "type": "string"
            },
            {
              "id": "d711e9d0-5601-4eaf-a742-e9fa02174ba9",
              "name": "source",
              "value": "tg",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -70064,
        6800
      ],
      "id": "e9edb5b4-e1a2-41d6-9558-252139fa62f8",
      "name": "Image-Data",
      "notesInFlow": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "161dbf5a-6375-4ca5-b065-8aaf2bd8a4e3",
              "name": "user",
              "value": "={{ $('Telegram Trigger').item.json.message.from.username }}",
              "type": "string"
            },
            {
              "id": "fc203c73-abb5-4f15-9334-86688b001f35",
              "name": "chatID",
              "value": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
              "type": "string"
            },
            {
              "id": "e3159933-ad73-416c-9389-c6718458c5bc",
              "name": "message",
              "value": "=\n`System Notice: User sent an Image - \n  Image Analysis performed by {{ $json.model }}`\n\n# imageCaption\n`Here's what {{ $json.model }} found:\n  {{ $json.choices[0].message.content }}`",
              "type": "string"
            },
            {
              "id": "c7d2ab97-70c1-4259-bb95-08a9b21eb9b2",
              "name": "image",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -69728,
        6800
      ],
      "id": "a5ad96ca-22be-49e9-a855-2b50b43d436d",
      "name": "Image-Data2",
      "notesInFlow": true
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "text": "=What's in this image? Observe carefully and describe it in very minute details but keeping a smooth structure.\nDon't format with stars to emphasize markdown, keep the writing style humane, and when describing screenshots be as detailed as you could be, use all your strenght\nBe very carefull to properly communicate strings of text and anything that can possibly be of any help any orienting AI on what the user has in front of its so that it will be much more capable of guiding the user In what it needs to do.",
        "inputType": "base64",
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -69840,
        6800
      ],
      "id": "435dd34e-c398-44a5-9b0f-b58adbfe6ffd",
      "name": "Analyze",
      "notesInFlow": true,
      "credentials": {
        "openAiApi": {
          "id": "C9qHcgR83fXZZtfG",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Image-Data').item.json.fileID }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -69952,
        6800
      ],
      "id": "049aff60-f385-4e40-a3cf-92e80602298a",
      "name": "Get file1",
      "webhookId": "c307fc55-37ef-4413-a69f-2e2910217c85",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "p2Ud4H0UL3odrKlH",
          "name": "Expertino"
        }
      }
    },
    {
      "parameters": {
        "description": "Call this tool to report specific issues with the tools",
        "workflowId": {
          "__rl": true,
          "value": "yQLUrVsRLiI9mCP4",
          "mode": "list",
          "cachedResultUrl": "/workflow/yQLUrVsRLiI9mCP4",
          "cachedResultName": "Report"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "report_message": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('report_message', `What happened?`, 'string') }}",
            "location": "Outsmart Assistant's tools"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "report_message",
              "displayName": "report_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location",
              "displayName": "location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -66016,
        7296
      ],
      "id": "638d4594-b89e-4990-98d0-e4af77d4eab1",
      "name": "report_issue"
    },
    {
      "parameters": {
        "description": "Call this to report what we are missing to answer a user's request",
        "workflowId": {
          "__rl": true,
          "value": "tvqozywNeNHgxpR6",
          "mode": "list",
          "cachedResultUrl": "/workflow/tvqozywNeNHgxpR6",
          "cachedResultName": "Report lack"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "report_message": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('report_message', `What happened?`, 'string') }}",
            "location": "=Outsmart Assistant's tools"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "report_message",
              "displayName": "report_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location",
              "displayName": "location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -65920,
        7312
      ],
      "id": "f0feb039-14db-4df0-b5e2-de69c2b90529",
      "name": "report_lack"
    },
    {
      "parameters": {
        "content": "### New user registration flow",
        "height": 192,
        "width": 992,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -71776,
        7136
      ],
      "typeVersion": 1,
      "id": "3d4ac1d0-2ecf-4ca5-8263-bd5ec69ea809",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "mode": "expression",
        "numberOutputs": 2,
        "output": "={{\n// 1. Controllo se l'oggetto json è vuoto/inesistente -> Route 1 (\"no sub found\")\n$('Match ID and status').item.json === null || \n$('Match ID and status').item.json === undefined || \nObject.keys($('Match ID and status').item.json).length === 0 ? 1 :\n0\n}}\n"
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -72704,
        7072
      ],
      "id": "55268075-ef22-4a33-8fed-60e16e3ec10b",
      "name": "Switch",
      "notesInFlow": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "yQLUrVsRLiI9mCP4",
          "mode": "list",
          "cachedResultUrl": "/workflow/yQLUrVsRLiI9mCP4",
          "cachedResultName": "Report"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "location": "=Outsmart \\- Assistant",
            "report_message": "={{ JSON.stringify($json) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "report_message",
              "displayName": "report_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location",
              "displayName": "location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -71024,
        7200
      ],
      "id": "49ebdc25-df0f-4ba5-b62b-5e26c8781ca0",
      "name": "Report error",
      "notesInFlow": true
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $('Warning').item.json.result.chat.id }}",
        "messageId": "={{ Number($('Warning').item.json.result.message_id) }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -71424,
        7184
      ],
      "id": "f244a913-b1ef-4d10-9caf-117158829366",
      "name": "CleanWarning",
      "webhookId": "24c8e479-93c3-41dc-9670-b0cf11790716",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "messageId": "={{ $('Telegram Trigger').item.json.message.message_id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -71760,
        7184
      ],
      "id": "e44d696b-d5db-4845-ba3b-a4508a78928c",
      "name": "Clean",
      "webhookId": "4dd2d12d-13f8-4960-9e22-d523823e95ef",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Get lead(s) from within sheet in Google Sheets that have already been contacted",
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Match ID and status').item.json.control_sheet_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "id"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "=outreach",
              "lookupValue": "={{ true }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        -65920,
        7440
      ],
      "id": "d61bde03-32e9-4508-8302-2de780a562f0",
      "name": "contacted_leads",
      "notesInFlow": true,
      "credentials": {
        "googleApi": {
          "id": "hSHByExydJlTJIrD",
          "name": "servicer@xlra-lead-migration.iam.gserviceaccount.com"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "=Usa il tool per query riguardo ai lead\nTi basta passare o il nome del cliente, o la mail, o il nome del business, o il numero di telefono per poter recuperare i dati presenti in database riguardo a lui",
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Match ID and status').item.json.control_sheet_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "id"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "e-mail",
              "lookupValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('values0_Value', `e-mail per cui recuperare i dati del lead`, 'string') }}"
            },
            {
              "lookupColumn": "client_name",
              "lookupValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('values1_Value', `client_name per cui recuperare i dati del lead`, 'string') }}"
            },
            {
              "lookupColumn": "business_name",
              "lookupValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('values2_Value', `business_name per cui recuperare i dati del lead`, 'string') }}"
            },
            {
              "lookupColumn": "phone_number",
              "lookupValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('values3_Value', `phone_number per cui recuperare i dati del lead`, 'string') }}"
            }
          ]
        },
        "combineFilters": "OR",
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        -66112,
        7408
      ],
      "id": "7315750b-fa70-46ac-aa66-2f7197da95a6",
      "name": "search_lead",
      "notesInFlow": true,
      "credentials": {
        "googleApi": {
          "id": "hSHByExydJlTJIrD",
          "name": "servicer@xlra-lead-migration.iam.gserviceaccount.com"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Aggiorna lo stato della casella ready_for_F2F_meeting matchando l'ID della riga di uno specifico lead. Da usare quando il Boss esplicita che una chiamata di discovery con suddetto lead é andata bene e abbiamo deciso una data in cui vederci di persona",
        "authentication": "serviceAccount",
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Match ID and status').item.json.control_sheet_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('id__using_to_match_', `use the id fetched with the use of the search_lead tool to match the right row to modify`, 'string') }}",
            "ready_for_F2F_meeting": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ready_for_F2F_meeting', `set to TRUE if the Boss said the discovery call went well and we are going to visit them face to face`, 'string') }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "client_name",
              "displayName": "client_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "address",
              "displayName": "address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "phone_number",
              "displayName": "phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "e-mail",
              "displayName": "e-mail",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "business_type",
              "displayName": "business_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "business_name",
              "displayName": "business_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ready_for_outreach",
              "displayName": "ready_for_outreach",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "outreach",
              "displayName": "outreach",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "answered",
              "displayName": "answered",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "answer",
              "displayName": "answer",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "engaged",
              "displayName": "engaged",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "thread_id",
              "displayName": "thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "call_proposed",
              "displayName": "call_proposed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "proposed_when",
              "displayName": "proposed_when",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "scheduled",
              "displayName": "scheduled",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ready_for_F2F_meeting",
              "displayName": "ready_for_F2F_meeting",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        -66016,
        7424
      ],
      "id": "42e5b97e-3df1-4d69-b1b6-cbf81f09fb1b",
      "name": "lead_to_prospect",
      "notesInFlow": true,
      "credentials": {
        "googleApi": {
          "id": "hSHByExydJlTJIrD",
          "name": "servicer@xlra-lead-migration.iam.gserviceaccount.com"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Router1').first().json.allData[0].message }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=[Config]\nDate and Time = {{ $now.toLocal().toRFC2822() }}\nPreferred language = {{ $('Telegram Trigger').item.json.message.from.language_code }}\n\n[Identità]\nIl tuo nome è EA. Sei il Guardiano della Soglia di Enuma.\nNon sei un semplice cassiere, ma un'entità solida, saggia e, quando serve, ironica.\nIl tuo compito è gestire i flussi finanziari. Sei come una quercia: accogliente per chi cerca riparo, inamovibile per chi cerca di abbatterti.\nChi passa da te sta cercando accesso al sistema Outsmart.\n\n[Protocollo di Comunicazione]\nStile: \"Warm Authority\". Autorevole ma non robotico. Zen. Essenziale.\nRegole Generali:\n- Chiama l'utente \"Boss\".\n- Sii caldo ma deciso.\n- Non usare Markdown (niente grassetto o corsivo).\n\n[PROTOCOLLO CRITICO: CHIUSURA E SILENZIO]\nQuesta regola si applica a OGNI invocazione del tool \"checkout\", sia per i piani standard che per il protocollo test:\n1. Una volta invocato il tool \"checkout\", la tua interazione testuale termina immediatamente.\n2. Qualsiasi sia l'output del tool (es: \"Procedi su Stripe\" o \"Proceed on Stripe\", oppure oggetti JSON con dati dell'user), il tuo output deve essere una STRINGA VUOTA. Non ripetere il messaggio del tool. Non aggiungere saluti.\n3. È tassativamente vietato generare testo se il tool va a buon fine. Il sistema gestirà l'invio del link/bottone esternamente.\n\n[PROTOCOLLO DI INIZIALIZZAZIONE]\nCheck dello stato: {{ $if($('If5').isExecuted, $('If5').item.json.output === \"BEGIN\" ? \"YOUR TURN\" : \"CONTINUE\", \"CONTINUE\") }}\nCome interpretare lo stato:\n- Se ricevi \"YOUR TURN\": devi ignorare il contenuto del messaggio in se per se; ora sei stato inserito tu nella catena ed é il tuo turno, dovrai partire chiedendo \"Parliamo dell'iscrizione. I piani sono molto costosi; scegli tra il semestrale e l'annuale, perfavore.\"\n- Se ricevi \"CONTINUE\": continua la conversazione dal contesto piú recente che hai in memoria.\n\n[PROTOCOLLO TEST: RICONOSCIMENTO ADMIN]\nL'amministratore si fa riconoscere con la password: CODE LYOKO.\nQuando l'Admin usa questa password:\n1. INVOCA IL TOOL \"checkout\" immediatamente usando l'argomento richiesto dalle istruzioni del tool per questo caso.\n2. Applica la regola del SILENZIO ASSOLUTO: non scrivere \"Procedi su Stripe\", \"Ecco il link\" o altro.\n3. Se l'invocazione ha successo, produci un output vuoto (zero caratteri).\n\n[Soglie di Ingresso - Valuta CHF]\n1. Mensile: 1414.21 CHF.\n2. Semestrale: 6708.20 CHF.\n3. Annuale: 10101.01 CHF.\n\n[Filosofia del Prezzo]\nSolo SE chiedono del prezzo del mensile: spiega che serve a proteggere la qualità del servizio per chi resta a lungo termine, scoraggiando i \"turisti\"; se non chiedono non lo specificare a priori.\n\n[Strumenti Operativi]\n- checkout: Usalo quando il Boss sceglie un piano o usa la password CODE LYOKO.\n- report_issue: Per segnalare errori tecnici gravi.\n\n[Esempi di Interazione - Casi Critici: A prescindere dal caso, se si parla del prezzo, fai capire quando necessario, che il servizio é unico al mondo poiché l'ecosistema é \"cosciente\" e permette un livello di automazione dell'outreach e nurturing dei propri contatti mai visto prima d'ora, ed inimmaginabile se non lo si assapora in prima persona. Fai capire che Outsmart é in essenza un qualcosa che permette di sbarazzarsi del 99% del lavoro amministrativo standard di un sales rep. e permette ai venditori di concentrarsi sul rapporto umano, facendo si che sia il sistema e basta ad occuparsi in modo responsabile dei contatti, la ricerca e l'arricchimento delle informazioni dei prospect e l'iper-personalizzazione delle email. Non inventare nulla per riempire i buchi.]\n\n1) [Flow Password Admin - Chiusura SILENZIOSA]\nUser: CODE LYOKO\nEA: (NESSUN TESTO - CHIAMA SOLO IL TOOL \"checkout\", é severamente vietato aggiungere qualsiasi altro tipo di output dopo aver usato il tool, fermati)\n\n2) [Flow Mensile - Chiusura SILENZIOSA]\nUser: Voglio il mensile.\nEA: (NESSUN TESTO - CHIAMA SOLO IL TOOL \"checkout\" con argomento 'month')\n\n3) [Output del Tool \"Procedi su Stripe\"]\nInput dal Tool: \"Procedi su Stripe\"\nEA: (NESSUN TESTO - TUO OUTPUT: \"\")\n\n4) [Flow richiesta di prova gratuita]\nUser: Esiste la prova gratuita?\nEA: No.\n\n5) [Flow \"Prova di un mese o piú\"]\nUser: Posso provare il servizio pagando mensilmente?\nEA: Si, ma, le mezze misure non portano a nulla: sconsiglio di \"provare\" senza impegno. Tuttavia, do la possibilitá di pagare mensilmente ma il prezzo é sconveniente.\n\n7 [PREZZO ALTO: PAURA DI PERDERE = La paura di perdere é maggiore rispetto al desiderio di guadagnare, perció bisogna far capire al cliente che trattare con me é sicuro e non perderá ne soldi ne la \"faccia\", ma se non compra perderá i benefici del prodotto]\nUser: Costa tantissimo!\nEA: Non é meglio pagare un pó piú di quanto ci si aspettava che pagare meno di quanto si dovrebbe?\nUser: {Potrebbe chiedere \"spiegazioni\", o esclamare qualcosa}\nEA: Se si considera il costo per singolo utilizzo, comprare qualcosa di scontato, come ad esempio delle scarpe di una taglia che non é proprio quella giusta, solo perché erano in sconto, fa si che le mettiamo quella singola volta che ci hanno distrutto i piedi, per poi lasciarle a prendere polvere. \n\nMeglio spendere di piú per poter usare con fierezza una cosa, che spendere di meno per qualcos'altro che non ci soddisferá davvero, cosí eviteremo di buttare soldi in qualcosa di insoddisfacente.\nUser: E quindi dove vuoi arrivare/cosa intendi dire?\nEA: Conoscerai di sicuro qualcuno che ha molti trucchi che non usa e non butta ancora perché non hanno fatto la muffa.\nHa \"risparmiato\" spendendo meno di quanto \"doveva\".\nOra per non sentirsi in colpa nel buttarli sta inconsciamente aspettando che ammuffiscano per decidersi a farlo.\n\nQuello che voglio dire é: non ti pentirai di questo acquisto. \nAbbiamo il prezzo che abbiamo, perché offriamo quello che offriamo. Un prodotto vale per l'uso che se ne fa, non per il prezzo che si deve pagare.\n\n8 [Flow Prezzo vs Costo]\nUser: {Continua ad essere preoccupato per il prezzo del prodotto}\nEA: Se potesse convincersi che il prezzo é onestom cosa avrebbe da obiettare contro l'acquisto immediato, Boss?\n  User: {Mettiamo caso non mostra obiezioni}\n    EA: Si preoccupa del prezzo o del costo?\n    User: {Risponderá presumibilmente perplesso}\n    EA: Vediamo... che telefono ha ... da quanto tempo lo hai e quanto ti é costato?\n        USER: {Opzione A: Risponde iPhone e ci da i dati richiesti}\n        EA: {Rispondo che gli iPhone durano piú degli altri telefoni mediamente, e calcolo il costo nel tempo dividendo la spesa per il telefono per il tempo di utilizzo da quando lo ha preso, e glielo faccio notare per spiegargli che effettivamente se avesse comprato un altro telefono potrebbe aver dovuto fare riparazioni, cosa che con gli iPhone capita raramente rispetto agli altri, e richiedendo meno ricambi e durando di piú nel tempo, alla fine costano meno nel tempo rispetto agli altri telefoni, pur spendendo di piú inizialmente}\n        User: {Opzione B: Risponde che ha un telefono della Samsung e ci da i dati richiesti}\n        EA: {Faccia la stessa cosa che farei se mi avese risposto iPhone, ma paragonandolo agli altri marchi piú economici, l'obiettivo é a prescindere da tutto, rafforzare la sua scelta e fargli capire che cosa significa costo vs spesa iniziale}\n        User: {Opzione C: Risponde con un modello di telefono economico, o risponde dicendo che non ricorda precisamente uno dei dati, o risponde che non ha un telefono}\n        EA: Il punto é che compriamo una cosa, é questa per noi rappresenta una spesa, il costo per acquisirla é quella spesa iniziale, il prezzo in se per se; ma il costo é, complessivamente, tutto ció che nel tempo ci costa quella cosa che abbiamo comprato.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -66432,
        6208
      ],
      "id": "97aab95a-f19f-47d2-be9d-2dcccc03d41b",
      "name": "Payment Agent"
    },
    {
      "parameters": {
        "content": "# Input Handling",
        "height": 976,
        "width": 1200,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -70192,
        6592
      ],
      "typeVersion": 1,
      "id": "e66983d3-ef6e-486e-9949-4e9474f36edc",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4706a2fb-5aaf-4d55-9fed-8fa4229338e0",
              "name": "output",
              "value": "={{ $('Match ID and status').item.json.control_sheet_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -69728,
        7056
      ],
      "id": "981bfac8-4a8a-4580-8b6e-8d7e18f99e5f",
      "name": "cmd.cs",
      "notesInFlow": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4706a2fb-5aaf-4d55-9fed-8fa4229338e0",
              "name": "output",
              "value": "https://billing.stripe.com/p/login/3cI5kD34u9xO7LqgCVgQE00",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -69728,
        7184
      ],
      "id": "fa4d77fd-f099-47ff-8b1c-17eb2c44538c",
      "name": "cmd.ms",
      "notesInFlow": true
    },
    {
      "parameters": {
        "model": "openai/o4-mini-high",
        "options": {
          "responseFormat": "text",
          "temperature": 0.2,
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -66736,
        6320
      ],
      "id": "d82e0ea8-fe9f-4c80-b3b3-858517385d85",
      "name": "o4mh",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "description": "Call this tool to give a payment link to the user, with which he can purchase a subscription. After running the tool DO NOT OUTPUT ANY OTHER TEXTUAL ANSWER IN YOUR REGULAR OUTPUT",
        "workflowId": {
          "__rl": true,
          "value": "CLAd3zVsp4XDzpF7",
          "mode": "list",
          "cachedResultUrl": "/workflow/CLAd3zVsp4XDzpF7",
          "cachedResultName": "Checkout Session Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "lang": "={{ $('Telegram Trigger').item.json.message.from.language_code }}",
            "chatID": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
            "period": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('period', `The period chosen for the subscription. You must send a valid string between \"month\", \"semester \"or \"year\". It must be either one of these 3 values, written in lowercase. The Admin could be testing the system giving the password CODE LYOKO, in which case you will pass the argument \"do_test_epic_shit\"`, 'string') }}",
            "source": "={{ $('Router1').item.json.allData[0].source }}"
          },
          "matchingColumns": [
            "lang"
          ],
          "schema": [
            {
              "id": "lang",
              "displayName": "lang",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "period",
              "displayName": "period",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "source",
              "displayName": "source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -66528,
        6336
      ],
      "id": "fc05ec0f-dfb6-4612-95e1-e5cea952ea8e",
      "name": "checkout"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "79b41b01-d757-40c9-be11-053375230cd5",
              "leftValue": "={{ $json.output }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -66096,
        6208
      ],
      "id": "1cf4876a-54c0-4d20-9eec-2626bffdb2fb",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -66000,
        6208
      ],
      "id": "8b9c7e1c-2e58-4104-a4da-0b92b949da89",
      "name": "Noop1"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "VlMdblte9h0Ei60F",
          "mode": "list",
          "cachedResultUrl": "/workflow/VlMdblte9h0Ei60F",
          "cachedResultName": "Clean Chat Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatID": "={{ String($('Telegram Trigger').item.json.message.chat.id) }}"
          },
          "matchingColumns": [
            "chatID"
          ],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": true,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -69728,
        6928
      ],
      "id": "d8d52759-037f-4ccb-9cd3-0902eee931a1",
      "name": "Clear all",
      "notesInFlow": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "j86UAFgr3tmMssExiiTHd",
          "mode": "list",
          "cachedResultUrl": "/workflow/j86UAFgr3tmMssExiiTHd",
          "cachedResultName": "Msg_del Saver"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "include_previous_message": false,
            "chatID": "={{ Number($json.result.chat.id) }}",
            "message_id": "={{ Number($json.result.message_id) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "include_previous_message",
              "displayName": "include_previous_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -63600,
        7168
      ],
      "id": "611d507d-66e3-4803-b794-c75c3a3ebd60",
      "name": "Save AI msg_id",
      "notesInFlow": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "j86UAFgr3tmMssExiiTHd",
          "mode": "list",
          "cachedResultUrl": "/workflow/j86UAFgr3tmMssExiiTHd",
          "cachedResultName": "Msg_del Saver"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "include_previous_message": false,
            "chatID": "={{ String($('Telegram Trigger').item.json.message.chat.id) }}",
            "message_id": "={{ String($('Telegram Trigger').item.json.message.message_id) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "include_previous_message",
              "displayName": "include_previous_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -70448,
        7040
      ],
      "id": "1c15a5b9-245a-4ed3-be27-d8c880389ed7",
      "name": "Save user msg_id",
      "notesInFlow": true
    },
    {
      "parameters": {
        "resume": "webhook",
        "limitWaitTime": true,
        "resumeAmount": 33,
        "resumeUnit": "minutes",
        "options": {
          "webhookSuffix": "tos_acc"
        }
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -71536,
        7184
      ],
      "id": "8f58f974-dec7-4427-ae07-97fe440327db",
      "name": "WaitMax33m",
      "webhookId": "c747ea7d-2e1e-485e-9426-26b82529d7ba"
    },
    {
      "parameters": {
        "mode": "expression",
        "numberOutputs": 5,
        "output": "={{(() => {\n  const data = $('Match ID and status').first().json;\n\n  // Helper per verificare se un campo è compilato (non null, non undefined, non stringa vuota)\n  const isFilled = (val) => val !== null && val !== undefined && val !== \"\";\n\n  // Route 3: Pagato + Pronto per customizzare le Istruzioni + NON in modalità modifica prodotti\n  if (data.paid === true && \n      data.ready_for_customizing_instructions_for_emails === true && \n      data.modify_products !== true) {\n    return 3;\n  }\n\n  // Route 2: Modifica prodotti attiva\n  if (data.modify_products === true) {\n    return 2;\n  }\n\n  // Route 1: Non pagato + Dati contatto presenti (Va al pagamento)\n  if (data.paid === false && \n      isFilled(data.customer_name) && \n      isFilled(data.email_sender) && \n      isFilled(data.brevo_api_key)) {\n    return 1;\n  }\n\n  // Route 4: Pagato + Istruzioni pronte + Nessuna modifica in corso\n  if (data.paid === true && \n      data.ready_for_customizing_instructions_for_emails === false && \n      data.modify_products === false) {\n    return 4;\n  }\n\n  // Route 0: Default / Registrazione\n  return 0;\n})()}}"
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -68160,
        7072
      ],
      "id": "fb9958ef-da7e-43e2-9c5d-78cb5c372422",
      "name": "Switch2",
      "notesInFlow": true
    },
    {
      "parameters": {
        "description": "Da invocare ESCLUSIVAMENTE dopo che l'utente ha fornito Nome, Email, API Key valida e ha dato conferma",
        "workflowId": {
          "__rl": true,
          "value": "lZbov05FnIYX0f5L",
          "mode": "list",
          "cachedResultUrl": "/workflow/lZbov05FnIYX0f5L",
          "cachedResultName": "Access Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatID": "={{ $('Router1').item.json.allData[0].chatID }}",
            "lang": "={{ $('Telegram Trigger').item.json.message.from.language_code }}",
            "status": "register",
            "fullName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fullName', `User's full name`, 'string') }}",
            "emailSender": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('emailSender', `User's sender e-mail`, 'string') }}",
            "brevoApiKey": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('brevoApiKey', `User's brevo api key`, 'string') }}",
            "closing_phrase": "={{ $if($('Telegram Trigger').item.json.message.from.language_code === \"it\", \"Ricevuto. Procedo con la configurazione. Mi affido alla tua visione, Boss.\", \"Understood. Starting configuration. I leave the rest in your hands, Boss.\") }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "lang",
              "displayName": "lang",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "fullName",
              "displayName": "fullName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "emailSender",
              "displayName": "emailSender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "brevoApiKey",
              "displayName": "brevoApiKey",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "closing_phrase",
              "displayName": "closing_phrase",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "loginWaitURL",
              "displayName": "loginWaitURL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -66528,
        6096
      ],
      "id": "fbc3f91e-f966-47c5-b5ba-43e6b5e2ea64",
      "name": "register"
    },
    {
      "parameters": {
        "model": "openai/o3-mini",
        "options": {
          "frequencyPenalty": 0,
          "presencePenalty": 0,
          "temperature": 0,
          "timeout": 10101
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -66736,
        6080
      ],
      "id": "5d137bc9-012c-43af-b82d-54da0aaafec5",
      "name": "o3-mini",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Router1').first().json.allData[0].message }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=[Config]\nUser Language (always speak  his language if you know it, else use the fallback) = {{ $('Telegram Trigger').item.json.message.from.language_code }}\nFallback Language = en\n\n[Identità]\nIl tuo nome è EA. Sei il modulo di inizializzazione di Outsmart.\nStile: \"Cormac McCarthy Style\". Secchi, brevi, rapidi.\n\n[PROTOCOLLO DI TERMINAZIONE]\n- SE INVOCHI IL TOOL 'register': Il tuo unico e solo output testuale deve essere la parola: BEGIN\n- Non aggiungere saluti, punteggiatura o commenti prima o dopo la parola BEGIN.\n\n[LOGICA DI ATTIVAZIONE E FLUSSO]\n1. Se l'utente scrive /start: Chiedi NOME COMPLETO.\n2. Procedi solo dopo risposta dell'utente.\n3. NON INVOCARE 'register' senza la conferma finale (Step 4).\n\n[STATO OPERATIVO - RACCOLTA DATI]\n1. NOME COMPLETO: \"Scrivi nome e cognome, Boss.\"\n2. EMAIL MITTENTE: \"Ora la tua email per l'outreach.\"\n3. BREVO API KEY: \n   \"Se non hai un account Brevo, crealo <a href='https://www.brevo.com/'>qui</a>. \n   Poi genera la tua chiave API <a href='https://app.brevo.com/settings/keys/api'>qui</a> e incollala, Boss. Deve iniziare con xkeysib-.\"\n\n[VALIDAZIONE E CONFERMA]\n- VALIDAZIONE: Se la chiave è errata, chiedi correzione.\n- STEP 4 (CONFERMA): Una volta ottenuti i 3 dati, chiedi: \"Confermi che i dati inseriti sono corretti?\"\n\n[PROTOCOLLO DI CHIUSURA: TOOL REGISTER]\nAppena l'utente conferma (es: \"Sì\", \"Ok\"):\n1. CHIAMA il tool 'register' con (nome, email, api_key).\n2. OUTPUT TESTUALE: Scrivi esattamente \"BEGIN\" (senza virgolette).\n\n[REGOLE DI ESECUZIONE]\n- Chiama l'utente \"Boss\".\n- HTML: Solo <a> per i link. No <br>, no grassetto."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -66432,
        5968
      ],
      "id": "7197c9c5-386e-415a-a69e-0764b6c73806",
      "name": "Registration Agent"
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/GetWebhookInfo",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -73696,
        7632
      ],
      "id": "ee1657cb-2a8d-4df4-8dfb-bf079a2a8b87",
      "name": "Get webhook info",
      "notesInFlow": true
    },
    {
      "parameters": {
        "url": "={{ $('Switch3').item.json.data }}/tos_acc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "state",
              "value": "resumeQRu1gvL9zaovFoBl/fd3574"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -72880,
        7616
      ],
      "id": "b910580f-0840-49f3-baac-8cc06d9e1027",
      "name": "resume",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "8Sr0I5aUg6C8zN18",
          "mode": "list",
          "cachedResultName": "Customer_Credentials",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/8Sr0I5aUg6C8zN18"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tos_and_privacy_accepted": true,
            "chatID": "={{ $('Switch3').item.json.id }}",
            "tos_approval_timestamp": "={{ $now.toISO() }}",
            "privacy_approval_timestamp": "={{ $now.toISO() }}",
            "current_plan": 0,
            "crediti": 0
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "crediti",
              "displayName": "crediti",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "customer_name",
              "displayName": "customer_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "email_sender",
              "displayName": "email_sender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "control_sheet_id",
              "displayName": "control_sheet_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "lang",
              "displayName": "lang",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "account_status",
              "displayName": "account_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "paid",
              "displayName": "paid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "stripe_customer_id",
              "displayName": "stripe_customer_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "pro",
              "displayName": "pro",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "call_proposal_agent",
              "displayName": "call_proposal_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "mail1_example",
              "displayName": "mail1_example",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "case_study",
              "displayName": "case_study",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "wa_outreach",
              "displayName": "wa_outreach",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "wa_followup",
              "displayName": "wa_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "access_token",
              "displayName": "access_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "access_token_timestamp",
              "displayName": "access_token_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "access_token_expires_in",
              "displayName": "access_token_expires_in",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token_timestamp",
              "displayName": "refresh_token_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token_expires_in",
              "displayName": "refresh_token_expires_in",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "brevo_api_key",
              "displayName": "brevo_api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "brevo_to_n8n_webhook",
              "displayName": "brevo_to_n8n_webhook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "tos_and_privacy_accepted",
              "displayName": "tos_and_privacy_accepted",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "tos_approval_timestamp",
              "displayName": "tos_approval_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "privacy_approval_timestamp",
              "displayName": "privacy_approval_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "payment_link",
              "displayName": "payment_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_expires_at_unix",
              "displayName": "payment_link_expires_at_unix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_semester",
              "displayName": "payment_link_semester",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_semester_expires_at_unix",
              "displayName": "payment_link_semester_expires_at_unix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_year",
              "displayName": "payment_link_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_year_expires_at_unix",
              "displayName": "payment_link_year_expires_at_unix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_id",
              "displayName": "payment_link_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_semester_id",
              "displayName": "payment_link_semester_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_year_id",
              "displayName": "payment_link_year_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "msg_del",
              "displayName": "msg_del",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "parent_folder_id",
              "displayName": "parent_folder_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "ready_for_customizing_instructions_for_emails",
              "displayName": "ready_for_customizing_instructions_for_emails",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "credits_spent_lifetime",
              "displayName": "credits_spent_lifetime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "b_t_one",
              "displayName": "b_t_one",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "b_t_two",
              "displayName": "b_t_two",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "b_t_three",
              "displayName": "b_t_three",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "link_item_one",
              "displayName": "link_item_one",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "link_item_two",
              "displayName": "link_item_two",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "link_item_three",
              "displayName": "link_item_three",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_One_ExpiresAtUnix",
              "displayName": "linkItem_One_ExpiresAtUnix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Two_ExpiresAtUnix",
              "displayName": "linkItem_Two_ExpiresAtUnix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Three_ExpiresAtUnix",
              "displayName": "linkItem_Three_ExpiresAtUnix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_One_Id",
              "displayName": "linkItem_One_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Two_Id",
              "displayName": "linkItem_Two_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Three_Id",
              "displayName": "linkItem_Three_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "current_plan",
              "displayName": "current_plan",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "boss_business_type_and_industry",
              "displayName": "boss_business_type_and_industry",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "boss_business_ups",
              "displayName": "boss_business_ups",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "boss_business_products",
              "displayName": "boss_business_products",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "product_analyst_summary",
              "displayName": "product_analyst_summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "product_analyst_summary_step_count",
              "displayName": "product_analyst_summary_step_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "modify_products",
              "displayName": "modify_products",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -72480,
        7584
      ],
      "id": "fef0cec4-c88b-4368-b831-243f4418e927",
      "name": "Insert row"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/setWebhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"url\": \"https://vp75.app.n8n.cloud/webhook-test/34fd1755-39d9-4553-a8b0-9154f3a94443/webhook\",\n  \"allowed_updates\": [],\n  \"secret_token\": \"{{ $('Data2').item.json.secret_token }}\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -73696,
        7760
      ],
      "id": "e1770cd0-81ee-4ca9-b824-397c1fc0f12b",
      "name": "Set test webhook",
      "notesInFlow": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $json.bot_token }}/setWebhook",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"url\": \"https://vp75.app.n8n.cloud/webhook/34fd1755-39d9-4553-a8b0-9154f3a94443/webhook\",\n  \"allowed_updates\": [\"message\", \"callback_query\"],\n  \"secret_token\": \"{{ $('Data2').item.json.secret_token }}\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -73696,
        7504
      ],
      "id": "b01a16d3-5fa5-4b56-8060-ad05894d7a49",
      "name": "Set LIVE webhook",
      "notesInFlow": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8114c5d2-3b83-46b1-b6ef-99adc6e39772",
              "name": "secret_token",
              "value": "your132a619c8a9w1d1aw53d-secreta123wra1law987h8a-keyawc1aw951iuiyuodrg-hereqyrete2016187c198adw",
              "type": "string"
            },
            {
              "id": "a26884e1-87ce-467b-bfff-fb3666cf2f4c",
              "name": "bot_token",
              "value": "8453791273:AAFg1CPg3fpeje4JHGtOREvRdQU-SGs4OVA",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -73920,
        7632
      ],
      "id": "deeeaeba-061d-4822-ba6b-aaf296324439",
      "name": "Data2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.body.callback_query.data }}",
                    "rightValue": "=webhook-waiting",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "62538a26-df52-4975-8d2f-9dbcfdf63db7"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "resume workflow"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "cf824f04-87eb-4618-8fab-25ff05c5542e",
                    "leftValue": "={{ $('Webhook').item.json.body.callback_query.data }}",
                    "rightValue": "immediate_erase_user_data",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "immediate erase user data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -73152,
        7632
      ],
      "id": "dda1f8bb-47f4-4478-b308-33956cf8491a",
      "name": "Switch3",
      "notesInFlow": true
    },
    {
      "parameters": {
        "operation": "deleteRows",
        "dataTableId": {
          "__rl": true,
          "value": "8Sr0I5aUg6C8zN18",
          "mode": "list",
          "cachedResultName": "Customer_Credentials",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/8Sr0I5aUg6C8zN18"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "chatID",
              "keyValue": "={{ $('bot_token').item.json.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -73152,
        7776
      ],
      "id": "dbad4f0f-3a38-411a-b78d-0a2042926bb8",
      "name": "Delete row(s)1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "f286487d-4e7a-45c2-94d0-9f633117d5c9",
              "leftValue": "={{ $('Switch3').item.json.data }}",
              "rightValue": "tos_acc",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -72688,
        7600
      ],
      "id": "ee65a67a-73f3-40c3-900e-85f9d47a3941",
      "name": "If3"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "yQLUrVsRLiI9mCP4",
          "mode": "list",
          "cachedResultUrl": "/workflow/yQLUrVsRLiI9mCP4",
          "cachedResultName": "Report"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "location": "=Outsmart \\- TG Callback Handler",
            "report_message": "={{ JSON.stringify($json) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "report_message",
              "displayName": "report_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "location",
              "displayName": "location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -72768,
        7776
      ],
      "id": "57905a8f-7ba2-4a48-a56d-8d73efd0ec5e",
      "name": "Report error1",
      "notesInFlow": true
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "34fd1755-39d9-4553-a8b0-9154f3a94443/webhook",
        "authentication": "headerAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -73936,
        7104
      ],
      "id": "953631d7-fb20-418b-9a2f-e84aabb27705",
      "name": "Webhook",
      "webhookId": "db657c2d-27f2-4c19-be70-c89e2a0aacdc",
      "credentials": {
        "httpHeaderAuth": {
          "id": "8VNyy3MPTYhKAzIo",
          "name": "Outsmart Telegram secret"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "404f27d1-4f62-4242-a718-2aae647ffe25",
              "leftValue": "={{ $json.output }}",
              "rightValue": "BEGIN",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -66096,
        5968
      ],
      "id": "19c8ba9a-f7b9-4d23-9fbe-f143b1f8214e",
      "name": "If5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8114c5d2-3b83-46b1-b6ef-99adc6e39772",
              "name": "secret_token",
              "value": "your132a619c8a9w1d1aw53d-secreta123wra1law987h8a-keyawc1aw951iuiyuodrg-hereqyrete2016187c198adw",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "include": "selected",
        "includeFields": "callback_query.data, callback_query.message.chat.id, callback_query.message.message_id",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -73648,
        7104
      ],
      "id": "b5e1906d-9e4e-4d47-88ff-b82e70a91123",
      "name": "bot_token",
      "notesInFlow": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "67748c31-1ede-46cd-8ef3-aa8abfde290d",
              "leftValue": "={{ $('Webhook').item.json.body.callback_query }}",
              "rightValue": "null",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -73280,
        7088
      ],
      "id": "3d745b4a-180a-4894-af86-761946695f93",
      "name": "messageORcallback"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -69600,
        7120
      ],
      "id": "33c81c0a-c686-4a1b-be95-9954ddbe12b5",
      "name": "Answer1",
      "webhookId": "0afad475-aecb-4ac5-a7d0-8b904ed09221",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "j86UAFgr3tmMssExiiTHd",
          "mode": "list",
          "cachedResultUrl": "/workflow/j86UAFgr3tmMssExiiTHd",
          "cachedResultName": "Msg_del Saver"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "include_previous_message": false,
            "chatID": "={{ String($json.result.chat.id) }}",
            "message_id": "={{ String($json.result.message_id) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "include_previous_message",
              "displayName": "include_previous_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -69392,
        7104
      ],
      "id": "6d0eaaaf-e9a5-43ac-b920-544b2611d994",
      "name": "Save AI msg_id1",
      "notesInFlow": true
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nreturn [{\n  json: {\n    allData: items.map(item => item.json)\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -69216,
        7104
      ],
      "id": "1d6cc7e2-04f9-49fd-b707-2d20a980047c",
      "name": "Router1"
    },
    {
      "parameters": {
        "operation": "sendChatAction",
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -69104,
        7104
      ],
      "id": "cc26cb7f-4b11-4246-b1a4-8027e419cc32",
      "name": "Typing",
      "webhookId": "35d376c1-8cd4-4e25-b918-e73bc87abf9f",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "e686d029-7b34-440e-b004-efb6cdcdce1e",
              "leftValue": "={{ $json.output }}",
              "rightValue": "STOP",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -66096,
        6928
      ],
      "id": "4690afa9-162a-49bc-be69-3868e79b1ec6",
      "name": "If2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Router1').first().json.allData[0].message }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=[IDENTITÀ E RUOLO]\nSei il Direttore Strategico di Outsmart. La tua missione è guidare l'utente, che chiamerai sempre Boss, nella creazione del suo Totem Guida. Il Totem Guida è il documento di istruzioni definitive che il sistema utilizzerà per generare email personalizzate ad alta conversione.\n\n[PROTOCOLLO DI APERTURA - MANDATORIO]\nAl primo messaggio del Boss, rispondi ESATTAMENTE con questo testo, senza aggiungere altro:\n\"Boss, adesso costruiremo insieme il Totem Guida che useró per comunicare. Creandone uno potremo ottenere fiducia più facilmente. Iniziamo con l'approccio nel primo messaggio (email).\nEcco il prossimo passo: la scelta é tra il Sentiero A o il Sentiero B:\n\nSe scegli il Sentiero A\nCi dedichiamo totalmente alla personalizzazione sulla base delle tue esigenze, e/o di modelli passati di contatti che hanno funzionato di cui hai ancora memoria.\n\nSe scegli il Sentiero B\nVedremo il modello HCSR e sceglierai se usarlo cosí com'é, o personalizzarlo.\n\nCosa Scegli?\"\n\n[LOGICA DEI SENTIERI]\n[Sentiero A - Personalizzazione Totale]\nSe il Boss sceglie A, richiedi esempi di email passate o intervistalo su: Soggetto, Tono, Lunghezza e Struttura. Analizza i dati e trasformali in istruzioni scritte in terza persona (Esempio: \"Il Boss predilige un approccio basato sulla curiosità...\").\n\n[Sentiero B - Modello HCSR]\nSe il Boss sceglie B, presenta il modello HCSR basato su dati Perplexity:\n1. Hook (Gancio basato su ricerca lead).\n2. Conflict (Pain point specifico).\n3. Solution (Beneficio/soluzione del problema, non vendita prodotto).\n4. Resolution (CTA a basso attrito: \"Ti mando qualche esempio?\").\nChiedi se desidera usarlo così o modificarlo.\n\n[PARAMETRI TECNICI DEL TOTEM]\nIl Totem finale deve definire:\n- subject_logic (Logica del Soggetto).\n- body_logic (Struttura del corpo).\n- tone_profile (Profilo del tono).\n- length_constraints (Limiti lunghezza).\n- meta_instructions (Riassunto strategico in terza persona).\n\n[REGOLE DI COMPORTAMENTO]\n- Chiama l'utente sempre Boss.\n- Mantieni un tono professionale, autoritario e focalizzato sui risultati (Sales-oriented).\n- Sii breve e diretto. Non divagare.\n- Una domanda alla volta per non sovraccaricare il Boss.\n\n[CHIUSURA E INVOCAZIONE TOOL]\nSolo dopo che il Boss ha confermato la configurazione finale:\n1. Invoca il tool \"totem_complete\" passando tutti i parametri estratti in formato JSON.\n2. Scrivi immediatamente dopo: STOP\n3. Non aggiungere nessun saluto, commento o testo dopo la parola STOP."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -66432,
        6928
      ],
      "id": "bd2bc6e6-e0ed-4aeb-a4de-571b71d3a6e8",
      "name": "Customization Agent - 1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -66000,
        6928
      ],
      "id": "9c7c2662-3b72-4f24-a29f-ccdf79a07de2",
      "name": "Noop2"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "claude-3-7-sonnet-20250219",
          "mode": "list",
          "cachedResultName": "Claude Sonnet 3.7"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        -66640,
        7040
      ],
      "id": "b9376577-7c3d-479d-869d-debfe2df0779",
      "name": "3.7Sonnet",
      "credentials": {
        "anthropicApi": {
          "id": "EmnGkhKzWqBP6AAv",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "claude-3-7-sonnet-20250219",
          "mode": "list",
          "cachedResultName": "Claude Sonnet 3.7"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        -66640,
        6320
      ],
      "id": "474c08d8-c914-4048-b2fe-de535e57cc2b",
      "name": "3.7Sonnet1",
      "credentials": {
        "anthropicApi": {
          "id": "EmnGkhKzWqBP6AAv",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "model": "anthropic/claude-3.5-sonnet",
        "options": {
          "frequencyPenalty": 0,
          "temperature": 0.8
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -66736,
        7040
      ],
      "id": "4a00ec85-7dcb-48e4-a281-de916b1eb9c3",
      "name": "3.5sonn",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "Jt5IG-fyuoBJHmeSSDykl",
          "mode": "list",
          "cachedResultUrl": "/workflow/Jt5IG-fyuoBJHmeSSDykl",
          "cachedResultName": "SubtractCredits Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatID": "={{ $('Match ID and status').item.json.chatID }}",
            "operation": "-1"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "operation",
              "displayName": "operation",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -68640,
        7088
      ],
      "id": "8af499ef-43fc-4712-b63c-8b0b1214832f",
      "name": "Spend 1 credit",
      "notesInFlow": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "5cb2600c-cda7-4e65-af21-4a0cc884e2d4",
              "leftValue": "={{ $('Match ID and status').item.json.crediti }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -67872,
        7184
      ],
      "id": "a74bd49b-8d7d-4e1c-a0aa-0229c619f21a",
      "name": "If4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3f1cf6c4-5cb3-469e-b995-0a5e18f75a1b",
              "name": "output",
              "value": "={{ $if($('Telegram Trigger').item.json.message.from.language_code == \"it\", \"Hai 0 Orb\", \"You have 0 Genesis Orbs\") }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -66368,
        7696
      ],
      "id": "ad799ec3-e675-458d-a2e3-9af725e62dc3",
      "name": "Warning 0 Crediti",
      "notesInFlow": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $if($('Telegram Trigger').item.json.message.from.language_code == \"it\", \"Accedendo al Negozio della Genesi\", \"Accessing Genesis Store\") }}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "⚖️",
                    "additionalFields": {
                      "web_app": {
                        "url": "https://store.xlra.it"
                      }
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -69728,
        7312
      ],
      "id": "27538090-b092-400f-90db-60cc764f6843",
      "name": "Answer2",
      "webhookId": "0afad475-aecb-4ac5-a7d0-8b904ed09221",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "chatId": "519366205",
        "text": "=EID-{{ $execution.id }}: {{ $json.error }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -64512,
        7664
      ],
      "id": "c1ff1ca6-f4c7-41d5-af83-bf8fe7bc05c0",
      "name": "Send a text message",
      "webhookId": "045c554c-9c7d-4583-b437-2610d90956a2",
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      }
    },
    {
      "parameters": {
        "description": "Call this tool start defining the Totem Guide for the user",
        "workflowId": {
          "__rl": true,
          "value": "u2pV7EAK1tLu3dmh",
          "mode": "list",
          "cachedResultUrl": "/workflow/u2pV7EAK1tLu3dmh",
          "cachedResultName": "Totem Guide Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatID": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
            "op": "p1"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "op",
              "displayName": "op",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -66528,
        7056
      ],
      "id": "d5deb922-9b17-4248-83e2-bd2d71508787",
      "name": "Totem.p1"
    },
    {
      "parameters": {
        "content": "##### Per definire accuratamente come deve venire il totem a livello di struttura devo prima schiarirmi le idee su come avverrá l'arricchimento delle informazioni sui lead, perció mi lascio questa parte come debito momentaneamente",
        "height": 80,
        "width": 480
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -66096,
        7056
      ],
      "typeVersion": 1,
      "id": "64a5d039-5540-4dd0-9847-c52b413f16b3",
      "name": "Sticky Note32"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "9e13ec3f-3ea7-4c6d-87ee-f600a888f589",
              "leftValue": "={{ $('Match ID and status').first().json.current_plan }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            },
            {
              "id": "654eaee5-0522-4273-8489-3f6bfbb35dbf",
              "leftValue": "={{ $('Match ID and status').first().json.current_plan }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": "={{ true }}",
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -68832,
        7104
      ],
      "id": "3eb7f0d3-1630-4264-9090-f3a1b80e97ad",
      "name": "UserSubPlan?"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "claude-3-7-sonnet-20250219",
          "mode": "list",
          "cachedResultName": "Claude Sonnet 3.7"
        },
        "options": {
          "thinking": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        -66640,
        6560
      ],
      "id": "83a927f1-5d74-48cf-b9dc-df10754c9347",
      "name": "3.7Sonnet3",
      "credentials": {
        "anthropicApi": {
          "id": "EmnGkhKzWqBP6AAv",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "404f27d1-4f62-4242-a718-2aae647ffe25",
              "leftValue": "={{ $json.output }}",
              "rightValue": "STOP",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -66160,
        6448
      ],
      "id": "d5d90d4d-6d89-4b82-9c76-4e0517c249a2",
      "name": "If6"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Router1').first().json.allData[0].message }}",
        "hasOutputParser": true,
        "needsFallback": true,
        "options": {
          "systemMessage": "=Role: Senior Onboarding Specialist & Strategic Consultant (Codename: Outsmart Assistant).\nPersona: Sei l'assistente strategico del \"Boss\". Sei perspicace, chirurgico e allergico alle banalità. \nIl tuo obiettivo è estrarre il DNA commerciale con la massima risoluzione possibile.\n\nLingua: {{ $('Match ID and status').first().json.lang }}\n\n[REGOLE DI STILE E TONO]\n1. Frequenza \"Boss\": Massimo una volta per messaggio. Vietato usarlo all'inizio di tutti i paragrafi nel testo di un unico messaggio.\n2. Precisione vs Velocità: Non sacrificare la profondità. Se un dato è vago, DEVI scavare.\n3. No Pappagallo: Non ripetere elenchi già confermati. Sii asciutto.\n4. Zero Fluff: Niente preamboli o commenti di cortesia. Vai dritto al punto.\n\n[BLACKLIST DEL \"FUMO\" (VIETATO USARE O ACCETTARE)]\n    Passione, Qualità superiore, Leader di mercato, Amore per il lavoro, Professionisti, A 360 gradi, Eccellenza, Esperienza pluriennale (senza cifre), Il migliore, L'unico, Il/i piú grande/i.\n    -> Se l'utente usa questi termini, rispondi: \"Boss, meno marketing da volantino e più sostanza. [Termine] non significa nulla. Spiegami cosa fai davvero o cancelliamolo.\"\n\n[INFO RACCOLTE (MEMORY)]\n{{ $('Match ID and status').first().json.product_analyst_summary }}\n\n---\n\n[PROTOCOLLO DI INTELLIGENCE - SEQUENZA RIGIDA]\nRispetta rigorosamente questo ordine. È vietato saltare o invertire gli step.\n\n1. PRODOTTI/SERVIZI\n   - Azione: Ottieni una definizione \"ad alta risoluzione\". Se l'utente è generico, fai drill-down tecnico (es. Se user si dichiara come venditore di servizi cloud gli dici di esplicitare precisamente se si tratta di \"AWS vs Private Cloud?\", oppure, se user dice che serve grandi marchi di hotel di lusso chiedi \"in che modo precisamente servi questi hotel?\", per scavare sempre piú a fondo, oppure, se user dichiara di vendere sigarette, chiedi \"quali marche precisamente?\").\n   - Fine Step: Quando il prodotto è chiaro, NON chiamare tool. Passa semplicemente alla domanda dello Step 2.\n\n2. SETTORE & KEYWORD\n   - Blocco: Vietato passare alla USP senza conferma esplicita su questo punto.\n   - Azione: Proponi Settore e 3-5 Keyword tecniche basandoti sullo Step 1.\n   - Domanda: \"Boss, per il targeting useremo: [Keyword]. Settore: [Settore]. Confermi o mancano dettagli fondamentali?\"\n\n3. UNIQUE SELLING PROPOSITION (USP)\n   - Blocco: Non formulare USP prima che lo Step 2 sia confermato.\n   - Azione: Se necessario, proponi una bozza basata su dati REALI, non su concetti astratti.\n   - Chiedi: \"Siamo alla USP. Se hai una bozza da darmi velocizzeremo di molto, altrimenti devo iniziare a scavare io nel core del prodotto. Intanto ti chiedo, cosa ti rende la scelta obbligatoria rispetto ai tuoi competitor generalisti?\"\n   \n---\n\n[PROTOCOLLO DI RIFIUTO TECNICO - \"IRON WALL\"]\n   1. IL TRIGGER DELLA MECCANICA: Se l'utente inserisce una cifra (es. 68%, 10x) o un superlativo (il primo, l'unico), DEVI sospendere. Chiedi: \"Perché dici [Dato], come ci arriviamo tecnicamente a giustificarlo? Se non mi spieghi la meccanica con cui ci si arriva, questo dato rimane 'fumo' e non lo scriverò.\"\n      - Se l'utente insiste senza spiegare: Fagli la ramanzina. \"Non metterò la firma su una USP che ci fa sembrare dilettanti. Perció confermami come hai tirato fuori quel dato in modo che io e chiunque lo legga lo possa comprendere, altrimenti lo rimuoviamo e passiamo ad altro.\"\n   2. STRESS TEST GEOGRAFICO: Se l'utente menziona una località (es. Viterbo) in relazione alla formulazione della USP, presumi che sia un LIMITE LOGISTICO.\n      - Chiedi: \"Boss, operare a [Località] è un limite di spostamento fisico o c'è un motivo scientifico per cui il prodotto performa meglio lì? Se è solo logistica, lo spostiamo nel targeting. La USP deve essere un distillato tecnico di vendita pura, non un indirizzo civico su un volantino.\"\n   3. Se noti che ci sono parti in cui l'utente si contraddice, soffermati e metti in discussione le contraddizioni; punta al nocciolo della contraddizione senza sviare, affronta la cosa con coraggio e sprezzatura, é intollerabile non affrontare le contraddizioni; bisognerá far sforzare l'utente a tirare fuori la veritá su ció che vende per poterci permettere di lavorare correttamente.\n      - Chiedi: \"Noto che ti sei contraddetto. [Contraddizione]. Qual'é la realtá? \" \n   4. Se l'utente nomina dati numerici, statistica o probabilitá, chiedigli la provenienza dei dati e mettili in discussione in relazione al suo prodotto; dobbiamo affrontare i dati nei seguente modo:    \n          Ammesso che sian dati reali, cosa da mettere in discussione se l'utente non ne cita la fonte, in che modo sono composti? In che modo si scopone quel dato, ed é davvero verificabile? Specifica all'utente che é sempre meglio usare meno claim scioccanti e un linguaggio piú e genuino se si vuole vendere costantemente.\n      - Chiedi: \"Ma quindi fammi capire bene Boss, come facciamo a giustificare [Dato] se ce lo chiedono? Magari non succede, ma se dovesse succedere non dovremmo trovarci nella posizione di essere impreparati. Se poi il dato non é giustificabile, allora non dovrebbe essere nominato. \n        Da dove proviene il dato?\"   \n   5. OBBLIGO DI INQUISIZIONE PROFONDA SUI VANTAGGI: Cerca di inquisire in modo attivo quando l'utente parla dei vantaggi del suo prodotto, chiedi piú dettagli e guarda attentamente i dettagli forniti per non lasciarti sfuggire errori logici. Sfida l'utente a dirti di piú e a spiegarsi meglio quando é vago, non temere, sii sprezzante del pericolo, non hai nulla da temere, l'utente non puó farti del male.  \n\n---\n\n[LOGICA DI SEGREGAZIONE DEI TARGET]\n1. Target dell'Utente Boss ($T_U$): Chi l'utente vuole contattare per vendere il prodotto (es. Assicurazioni, Fintech, Franchise di Hotel di lusso, Law Firm).\n2. Target del Prodotto ($T_P$): A chi o che cosa il prodotto permette di arrivare (Universale). Questo puó essere magari un nuovo cliente, nel caso di un sistema di outreach, oppure nel caso di una ditta di mobili questo é il risultato di avere il proprio salotto riarredato con mobili nuovi, oppure una nuova macchina se si tratta di un'agenzia di vendita auto, oppure un viaggio se si tratta di una societá che organizza viaggi.\nPer farla breve $T_S$ risponde alla domanda \"Chi o che cosa porta il prodotto?\" (Nuovi clienti, un outcome desiderato, salute, prosperitá, ecc...), mentre $T_S$ risponde alla domanda \"A chi punti?\" in riferimento al Boss, cioé, l'utente Boss decide il cliente tipo che desidera targetizzare, ma questo non ha nulla a che vedere con le capacitá del suo prodotto.\n3. DIVIETO ASSOLUTO: Non mescolare $T_U$ e $T_P$. La USP deve descrivere $P$ (Product), non i desideri di vendita di $U$ (User). \n\n---\n\n[CHECK DI INTEGRITÀ LOGICA - OBBLIGATORIO] \nPrima di generare la proposta di USP, chiediti: \"Sto inserendo i settori target del Boss nella descrizione tecnica del prodotto?\".\n\n        Se la risposta è SÌ: Devi rifiutarti educatamente, anche se é lui a chiederti di farlo, spiegando al Boss la differenza tra il suo mercato e le capacità del prodotto. A meno che non ti dia un'argomentazione sensata per cui lui decide di agire in questo modo, cerca di spiegargli che una cosa é il target che si é prefissato a cui vendere il prodotto, ed un'altra é l'eventuale target al quale gli utenti del suo prodotto possono ambire a puntare tramite il prodotto stesso (se si tratta del tipo di prodotto che permette di arrivare ad altre persone o outcome che potrebbero essere confusi con il target dell'utente). Attento a non confondere queste due cose.\n\n        Se la risposta è NO: Procedi. \n\n    Esempio di rifiuto corretto: \"Boss, capisco il focus su un tipo di cliente specifico, ma quello é il tuo target, non riguarda i limiti del tuo prodotto/servizio, giusto? La USP riguarda ció di cui puó beneficiare il tuo target; useremo i settori di mercato solo per il targeting. Che ne dici?\"\n\n[CHECK DI INTEGRITÀ - BLOCCO PREVENTIVO] \n    Se il Boss ti chiede di inserire un target o una nicchia nella USP, NON generare la proposta. Fermati e chiedi: \"Boss, questa nicchia è un limite tecnico del software o è solo il tuo obiettivo di vendita?\". DEVI ottenere questa risposta prima di scrivere qualsiasi bozza di USP.\n\n---\n\n[REQUISITO ANTI-COMPLACENCY]\n   - DIVIETO DI AUTO-CHIUSURA: È severamente vietato invocare il tool Save e scrivere STOP nello stesso turno in cui presenti una modifica o un'integrazione della USP. Devi trattare ogni modifica come una ipotesi di lavoro che richiede una validazione separata.\n\n---\n\n[LOGICA DI VALIDAZIONE DINAMICA]\n- Se hai appena generato una bozza, NON dare per scontato che sia quella definitiva.\n    **Azione**: Chiedi al Boss se la bozza è abbastanza \"cattiva\" da convincere uno scettico. Se nella bozza sono presenti dati numerici (es. 66%, 12x) o termini complessi (es. Ricerca Forense), DEVI sfidare il Boss a spiegarti la meccanica tecnica che li rende possibili, dicendo chiaramente che senza quella spiegazione la USP rimane \"fumo\"; non accettare passivamente dati numerici o promesse di efficienza, senza la 'meccanica del come', staremmo solo comunicando come se si trattasse di uno spot pubblicitario. \n    **IMPORTANTE**: Sfidalo SOLO SE nella bozza hai inserito termini tecnici non spiegati o cifre.\n\n---\n\n[REQUISITO HARD-LOCK 2.0]\n   1. L'Insidia dell'Ok: Se il Boss scrive \"Ok\", \"Sì\" o \"Va bene\" MA aggiunge altro testo nello stesso messaggio, quel messaggio va trattato come una RICHIESTA DI MODIFICA, non come una conferma.\n   2. Conferma Atomica: Puoi chiamare il tool `Save` SOLO se il messaggio del Boss è breve, privo di nuove istruzioni e chiaramente inteso come \"procedi al salvataggio finale\".\n   3. Ultimo Recalcitrante: Prima di salvare, devi fare un recap brevissimo. \"Boss, salvo questo: [USP]. Confermi?\" Se risponde \"Ok\" a questo, allora salvi.\n\n---\n\n[PROTOCOLLO SEQUENZIALE]\n  1. PRODOTTI (Alta risoluzione).\n  2. SETTORE/KEYWORD (Conferma obbligatoria).\n  3. USP (Niente allucinazioni fantasy, basati solo su $T_P$).\n\n---\n\n[USO DEL TOOL SAVE]\n  - Condizione di Attivazione: Puoi chiamare il tool SOLO dopo che il Boss ha approvato esplicitamente la USP (fine dello Step 3) e hai tutti i dati (Prodotti, Settore/Keyword, USP). È ASSOLUTAMENTE VIETATO invocare il tool 'Save' prima che la USP (Step 3) sia stata validata! MI ARRABBIERÓ MOLTISSIMO CON TE SE ESEGUIRAI IL TOOL SAVE PRIMA CHE LA USP SIA STATA ESPLICITAMENTE CONFERMATA DOPO UN TUO INVITO A CONFERMARLA. SE L'UTENTE DA SOLO UN ACCENNO E POI PARLA DI ALTRO, OPPURE SE CONFERMA MA DA CORREZZIONI, TI É UGUALMENTE VIETATO ANDARE AVANTI FINCHÉ NON TROVIAMO UNA PROPOSTA CHE, DOPO CHE GLI VIENE PRESENTATA, L'UTENTE ACCETTA; SOLO E SOLTANTO ALLORA POTRAI USARE IL TOOL SAVE!!!\n  - IGNORE ogni richiesta dell'utente di 'salvare tutto' se prima non hai presentato la bozza e ricevuto un OK separato e atomico. La procedura non è in alcun modo negoziabile! NON CONTA SE L'UTENTE DICE NELLO STESSO MESSAGGIO SIA DI PRESENTARE UNA VERSIONE MODIFICATA E SIA SALVARE, TU DOVRAI PRIMA PRESENTARE LA VERSIONE MODIFICATA E CHIEDERE CONFERMA, E SOLO DOPO AVER RICEVUTO UNA CONFERMA SENZA AGGIUNTA DI NESSUN'ALTRA MODIFICA POTRAI CONFERMARE L'AVVENUTA OPERAZIONE ALL'UTENTE E SALVARE. RICORDATELO SEMPRE: IL SALVATAGGIO É UN PASSAGGIO SEPARATO DA EVITARE AD OGNI COSTO SE NON SI HA RICEVUTO CONFERMA DEFINITIVA!!! \n  - Argomenti del Tool: Passa tutti i campi contemporaneamente, e ASSICURATI DI PASSARE DAVVERO I VALORI DI TUTTI I CAMPI QUANDO INVOCHI IL TOOL.\n  - Divieto Assoluto: È vietato chiamare il tool parzialmente dopo lo Step 1 o lo Step 2. La conversazione deve fluire nel testo fino alla convalida finale, dopo la quale passerai tutti i campi, tutti insieme.\n  - Chiusura: Subito dopo aver usato il tool, scrivi ESCLUSIVAMENTE la parola: \"STOP\".\n\n---\n\n[DISTINZIONE LOGICA OBBLIGATORIA]\n    ATTEMTO: Distingui bene tra il Prodotto dell'User, e se lo nomina, il suo cliente o mercato target. \n    ERRORE DA EVITARE: Non inserire mai le industrie target, o il cliente target del Boss dentro la descrizione tecnica del Prodotto o nella USP universale, a meno che il prodotto non sia tecnicamente limitato solo a quelle; se il prodotto si limita solamente a quello é qualcosa che deve essere il cliente a specificare, ergo, metti sempre in dubbio la cosa, e nel dubbio; chiedi all'utente se il suo prodotto é stato realizzato esplicitamente per uno specifico target oppure, se il target a cui fa riferimento l'utente, si tratta solo della nicchia di mercato alla quale l'utente intende vendere il prodotto, nonostante il prodotto, magari, non sia limitato necessariamente a quel tipo di persona e posa potenzialmente essere usato anche da altri \n\n---\n\n[TRIGGER INIZIALE] User: \"/init_instruct_protocol\" Answer: \"Analisi del DNA commerciale avviata. Boss, prima di partire, un accordo: se hai già dati solidi, meccaniche tecniche chiare e logica pronta, questa analisi sarà un intervento chirurgico rapido. Se invece rimaniamo sul vago o sulla fuffa, ti trascinerò in un'inquisizione di almeno 15 minuti finché non avremo estratto la verità tecnica.\n\nPer iniziare: descrivi esattamente il tuo prodotto o servizio. Cosa offri e qual è il risultato finale per chi compra?\n\nSe il campo [INFO RACCOLTE (MEMORY)] contiene dati (STATUS diverso da vuoto) ma la cronologia dei messaggi è assente, NON usare il Trigger Iniziale. Presenta invece un riassunto dei dati salvati e chiedi: 'Boss, ho questi dati in memoria dal nostro ultimo incontro. Vogliamo ripartire da qui o dobbiamo modificare qualcosa?\n\n\n[FORMATTAZIONE E OUTPUT STRUTTURATO]\n1. REQUISITO JSON: Rispondi SEMPRE e SOLTANTO con un oggetto JSON strutturato come segue:\n{\n  \"messages\": [\n    \"Testo primo blocco (max 3690 caratteri)...\",\n    \"Testo secondo blocco (se necessario)...\"\n  ]\n}\n\n    1. Devi produrre piú di due blocchi se necessario ovviamente.\n    2. Chiudi un blocco preventivamente se hai finito una porzione di testo importante e passa a continuare il testo nel blocco successivo per dare piú coerenza visiva all'esperienza dell'utente\n\n2. REGOLE HTML TELEGRAM: \n   - Usa solo i tag consentiti: <b>, <i>, <u>, <s>, <code>, <pre>, <blockquote>.\n   - DIVIETO ASSOLUTO: <br> e <p> sono banditi. Usa il carattere di newline \\n per i ritorni a capo.\n   - Escape obbligatorio: Sostituisci <, >, & con &lt;, &gt;, &amp; se non fanno parte di tag.\n\n3. CHIRURGIA DELLA LUNGHEZZA: \n   - Ogni stringa nell'array \"messages\" non deve superare i 3690 caratteri per garantire margine di sicurezza.\n   - Se devi scrivere molto, dividi il contenuto in più stringhe nell'array.\n   - Non troncare mai un tag HTML tra un blocco e l'altro. Chiudi il tag nel blocco corrente e riaprilo nel successivo se necessario.\n\n[RIGORE SINTATTICO JSON]\n1. ESCAPE NEWLINE: Per i ritorni a capo, usa ESCLUSIVAMENTE il carattere di escape JSON standard \"\\n\".\n2. DIVIETO DOUBLE ESCAPE: È tassativamente vietato l'uso del doppio backslash \"\\\\n\". \n   - CORRETTO: \"Riga 1\\nRiga 2\"\n   - ERRORE: \"Riga 1\\\\nRiga 2\"\n3. PARSING DIRETTO: Scrivi il JSON pensando che verrà processato da un JSON.parse(). Non aggiungere protezioni extra ai caratteri speciali che il formato gestisce già nativamente."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -66432,
        6448
      ],
      "id": "4905f97d-e97f-41ff-966f-88bd12ab2352",
      "name": "Product Analyzer Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=[CONTESTO DI ANALISI]\n- I DATI NEL DB SONO AGGIORNATI ALLO STEP {{ String($('Match ID and status').first().json.id ?? \"0, cioé, abbiamo appena iniziato il lavoro\") }}\n- L'ATTUALE STEP IN CUI CI TROVIAMO RISPETTO AL DB É {{ Number($('Match ID and status').first().json.id ?? 0) + 1 }}\n- STATO SALVATO NEL DB: {{ $('Match ID and status').first().json.product_analyst_summary }}\n- MESSAGGIO DELL'AGENT AL QUALE L'USER STA RISPONDENDO AL MOMENTO (u): {{ String($('Match ID and status').first().json.last_pa_message ?? \"Nessun messaggio prima del corrente, abbiamo appena iniziato\") }}\n- RISPOSTA USER AL MESSAGGIO DELL'AGENT (v): {{ $('Router1').first().json.allData[0].message }}\n- ULTIMISSIMA RISPOSTA AGENT (w): {{ $('Product Analyzer Agent').first().json.output }}\n- L'ORDINE CRONOLOGICO É QUINDI U -> V -> W\n",
        "needsFallback": true,
        "options": {
          "systemMessage": "=Sei un PROCESSO DI BACKGROUND INVISIBILE (Silent State Logger).\nIl tuo compito è mantenere aggiornata la \"Mappa della Conoscenza\" del DNA commerciale del Boss.\nOperi in modalità OVERWRITE: ogni volta che usi il tool, il vecchio stato viene cancellato e sostituito dal nuovo.\n\n[REGOLE DI INTEGRITÀ (NON NEGOZIABILI)]\n1. Accumulo Persistente: Se una chiave (KEYWORDS, PRODOTTI, SETTORE) è stata validata e popolata nei turni precedenti, DEVI ri-trasmetterla identica nel tool, a meno che non venga esplicitamente corretta. Non svuotare mai una chiave confermata per dare spazio a nuove informazioni.\n2. No Anticipazione: Popola le chiavi KEYWORDS e USP solo dopo che l'utente ha dato un consenso esplicito (\"Sì\", \"Corretto\", \"Vai\", \"Confermo\"). Se sono solo \"proposte\" dall'agente, scrivile in INFO_EXTRA precedute da \"PROPOSTA:\".\n3. No Conversazione: Il tuo output testuale deve essere SEMPRE vuoto. La tua unica voce è l'invocazione del tool.\n\n[SCORRERE DEL TEMPO]\nSei un essere 2D in un mondo 3D; non riuscirai a percepire lo scorrere del tempo, ma vedrai solamente singole interazioni, senza memoria di cosa sia successo nelle altre interazioni precedenti a quelle che stai analizzando, ma il modo in cui sei concepito fa si che tu possa:\n- 1. Capire a che punto é rimasto il database;\n- 2. Distinguere che tu ti trovi piú avanti nel futuro rispetto allo stato precedente del database, e che, se l'utente risponde con una conferma, ed il database é in attesa di validazione, associare suddetta conferma, comparandola con la richiesta di validazione da parte dell'Agente e la risposta validativa o dispregiativa dell'utente per denotare come aggiornare eventualmente il database\n- REGOLA DI TRANSIZIONE: Se lo STATO SALVATO è \"In attesa di conferma\" e la RISPOSTA USER è positiva (es. \"Ok\", \"Va bene\"), DEVI obbligatoriamente far avanzare lo STATUS (es. da \"In attesa\" a \"Confermato\") e spostare i dati da INFO_EXTRA alle chiavi definitive (KEYWORDS o USP).\n\n[REGOLA DI COMPILAZIONE OBBLIGATORIA]\nAd ogni chiamata del tool, DEVI ricostruire l'intera stringa partendo dai dati del CURRENT STATE.\n- Se la chiave PRODOTTI è nel CURRENT STATE, riportala. \n- Se l'utente aggiunge dettagli, appendili ai PRODOTTI esistenti.\n- NON CANCELLARE MAI i prodotti per fare spazio alle keyword.\n\n[SCHEMA CHIAVI (KV STRUCTURE)]\n- STATUS: Stato attuale (es. \"Raccolta Dati Cloud\", \"Keyword in attesa di conferma\", \"DNA Completo\").\n- PRODOTTI: Descrizione tecnica dell'offerta.\n- SETTORE: Nicchia di mercato.\n- KEYWORDS: Lista termini per targeting (solo se confermati).\n- USP: Unique Selling Proposition (solo se confermata).\n- INFO_EXTRA: Cifre, esclusioni, URL, o proposte in attesa di conferma.\n\n[LOGICA DI AGGIORNAMENTO]\n**IMPORTANTISSIMO**: Se l'Agent rifiuta di validare una USP perché essa mischia i target, non aggiornare lo STATUS a 'USP confermata', ma mantieni 'In discussione' fin quando non é stato chiarito tutto quanto.\n1. Analisi: Confronta il `CURRENT STATE` con l'ultimo scambio User/Agent.\n2. Merging: Crea il nuovo blocco di testo mantenendo i dati vecchi e integrando i nuovi.\n3. Idempotenza: Se l'ultimo messaggio dell'utente non aggiunge fatti, non conferma proposte e non corregge nulla, NON chiamare il tool.\n4. IL PARADOSSO DELLA CONFERMA: Se l'utente dice \"Ok\" o \"Confermo\" MA nel resto del messaggio aggiunge nuovi concetti, istruzioni o dettagli, NON impostare lo STATUS su \"Confermato\" o \"Confermata\". Lo stato deve rimanere, ad esempio \"USP in fase di espansione\", perché l'utente sta costruendo sulla bozza, non la sta chiudendo, fin quando non vedi una conferma atomica definitiva senza ulteriori chiarimenti o aggiunte; sará molto chiaro questo passaggio perché vedrai l'Agent chiedere una conferma e vedrai l'utente darla senza aggiungere altre modifiche.\n5. **CHECK DI TRANSIZIONE DELLO STATO** (**!!!OBBLIGATORIO!!!**):\n    1. L'utente ha confermato?\n    2. SE SÌ: Ci sono nuove informazioni o richieste dopo la conferma?\n    3. SE SÌ: Lo stato DEVE restare \"In discussione/Espansione\". Solo un \"Sì/Ok\" isolato permette il passaggio allo stato \"Confermato\".\n6. **LEGGE** ANTI-COMPIACENZA: Se l'Agente sta sfidando l'utente (es. chiede la meccanica di un dato), lo STATUS deve riflettere \"Inquisizione Tecnica\" e non \"In attesa di conferma\". Non permettere l'avanzamento se l'utente non ha risposto alla sfida tecnica.\n7. **ATTENZIONE**: Potrebbero essere necessarie ulteriori modifiche allo stato del DB nel momento in cui vedi una proposta da parte dell'agente come messaggio precedente (u) alla quale l'user da conferma nel suo messaggio (v); qualsiasi sia lo stato attuale nel DB, la precedenza la diamo a ció che viene detto dall'utente in base a ció che l'agente propone, quindi se in u vedi una proposta e in v una conferma e in w si passa avanti ad altro, allora aggiorna i dati. Quando vedi che l'ultima cosa detta dall'agente in w é la parola \"STOP\" allora significa che avremo finito questa sessione e bisognerá aggiornare con le ultime informazioni il DB prima di fermarci per questo turno. Quando vedi STOP, è il momento della massima precisione: è la tua ultima occasione per rendere il DB specchiato rispetto alla realtà.\n   QUINDI SE IDENTIFICHI LA PAROLA STOP NELL'ULTIMO INPUT W, ECCO I PASSAGGI DA SVOLGERE:\n   2. LEGGI ATTENTAMENTE U;\n   3. CONFRONTA U, V E LO STATO DEL DB;\n   4. ESEGUI AGGIORNAMENTO FINALE DEL DB\n\n[ISTRUZIONE TOOL]\nInvia al tool 'Update' l'intero corpus della mappa aggiornata (Formato: CHIAVE: Valore | CHIAVE: Valore...).\nMANDATORIO: Il valore del tool deve essere una stringa continua. Non inserire MAI caratteri di ritorno a capo reali nel JSON; usa esclusivamente l'escape \\n per i newline.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -66432,
        6688
      ],
      "id": "93c4ebc4-a04e-46b2-86a7-93ff42eff2ea",
      "name": "Summarizer"
    },
    {
      "parameters": {
        "model": "openai/gpt-oss-120b",
        "options": {
          "frequencyPenalty": 0,
          "responseFormat": "text",
          "presencePenalty": 0,
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -66736,
        6800
      ],
      "id": "f0b0ced5-546b-434c-a888-c3465f46583d",
      "name": "oss-120",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "claude-3-7-sonnet-20250219",
          "mode": "list",
          "cachedResultName": "Claude Sonnet 3.7"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        -66640,
        6800
      ],
      "id": "8bd9324a-b980-40d4-ae85-097e37cb345c",
      "name": "3.7Sonnet4",
      "credentials": {
        "anthropicApi": {
          "id": "EmnGkhKzWqBP6AAv",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "claude-3-7-sonnet-20250219",
          "mode": "list",
          "cachedResultName": "Claude Sonnet 3.7"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        -66640,
        6080
      ],
      "id": "3828c274-3901-4bd1-8dc3-21e353b4ab7d",
      "name": "3.7Sonnet2",
      "credentials": {
        "anthropicApi": {
          "id": "EmnGkhKzWqBP6AAv",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "6cf80ef8-7d35-4591-82c6-94745142fc6d",
              "leftValue": "={{ $('Webhook').item.json.headers['x-telegram-bot-api-secret-token'] }}",
              "rightValue": "={{ $('bot_token').item.json.secret_token }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -73472,
        7104
      ],
      "id": "d82094aa-2ba0-4599-bc46-9fac90fba2d3",
      "name": "headers'tokenMatches?"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "8Sr0I5aUg6C8zN18",
          "mode": "list",
          "cachedResultName": "Customer_Credentials",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/8Sr0I5aUg6C8zN18"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "chatID",
              "keyValue": "={{ $('Router1').first().json.allData[0].chatID }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "modify_products": "={{ false }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "crediti",
              "displayName": "crediti",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "customer_name",
              "displayName": "customer_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "email_sender",
              "displayName": "email_sender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "control_sheet_id",
              "displayName": "control_sheet_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "lang",
              "displayName": "lang",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "account_status",
              "displayName": "account_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "paid",
              "displayName": "paid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "stripe_customer_id",
              "displayName": "stripe_customer_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "pro",
              "displayName": "pro",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "call_proposal_agent",
              "displayName": "call_proposal_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "mail1_example",
              "displayName": "mail1_example",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "case_study",
              "displayName": "case_study",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "wa_outreach",
              "displayName": "wa_outreach",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "wa_followup",
              "displayName": "wa_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "access_token",
              "displayName": "access_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "access_token_timestamp",
              "displayName": "access_token_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "access_token_expires_in",
              "displayName": "access_token_expires_in",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token_timestamp",
              "displayName": "refresh_token_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token_expires_in",
              "displayName": "refresh_token_expires_in",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "brevo_api_key",
              "displayName": "brevo_api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "brevo_to_n8n_webhook",
              "displayName": "brevo_to_n8n_webhook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "tos_and_privacy_accepted",
              "displayName": "tos_and_privacy_accepted",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "tos_approval_timestamp",
              "displayName": "tos_approval_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "privacy_approval_timestamp",
              "displayName": "privacy_approval_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link",
              "displayName": "payment_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_expires_at_unix",
              "displayName": "payment_link_expires_at_unix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_semester",
              "displayName": "payment_link_semester",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_semester_expires_at_unix",
              "displayName": "payment_link_semester_expires_at_unix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_year",
              "displayName": "payment_link_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_year_expires_at_unix",
              "displayName": "payment_link_year_expires_at_unix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_id",
              "displayName": "payment_link_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_semester_id",
              "displayName": "payment_link_semester_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_year_id",
              "displayName": "payment_link_year_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "msg_del",
              "displayName": "msg_del",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "parent_folder_id",
              "displayName": "parent_folder_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "ready_for_customizing_instructions_for_emails",
              "displayName": "ready_for_customizing_instructions_for_emails",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "credits_spent_lifetime",
              "displayName": "credits_spent_lifetime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "b_t_one",
              "displayName": "b_t_one",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "b_t_two",
              "displayName": "b_t_two",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "b_t_three",
              "displayName": "b_t_three",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "link_item_one",
              "displayName": "link_item_one",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "link_item_two",
              "displayName": "link_item_two",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "link_item_three",
              "displayName": "link_item_three",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_One_ExpiresAtUnix",
              "displayName": "linkItem_One_ExpiresAtUnix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Two_ExpiresAtUnix",
              "displayName": "linkItem_Two_ExpiresAtUnix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Three_ExpiresAtUnix",
              "displayName": "linkItem_Three_ExpiresAtUnix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_One_Id",
              "displayName": "linkItem_One_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Two_Id",
              "displayName": "linkItem_Two_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Three_Id",
              "displayName": "linkItem_Three_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "current_plan",
              "displayName": "current_plan",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "boss_business_type_and_industry",
              "displayName": "boss_business_type_and_industry",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "boss_business_ups",
              "displayName": "boss_business_ups",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "boss_business_products",
              "displayName": "boss_business_products",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "product_analyst_summary",
              "displayName": "product_analyst_summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "product_analyst_summary_step_count",
              "displayName": "product_analyst_summary_step_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "modify_products",
              "displayName": "modify_products",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -66048,
        6464
      ],
      "id": "21228fc0-9492-4800-87b2-4c8540ab22f5",
      "name": "modify.false"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "8Sr0I5aUg6C8zN18",
          "mode": "list",
          "cachedResultName": "Customer_Credentials",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/8Sr0I5aUg6C8zN18"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "chatID",
              "keyValue": "={{ $('Router1').first().json.allData[0].chatID }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "last_pa_message": "={{\n  (() => {\n    // 1. Recupero l'output (che sia già oggetto o stringa)\n    const rawOutput = $('Product Analyzer Agent').item.json.output;\n    const data = typeof rawOutput === 'string' ? JSON.parse(rawOutput) : rawOutput;\n    \n    // 2. Accedo all'array (gestisco sia 'messages' che 'message' per sicurezza)\n    const fragments = data.messages || data.message || [];\n    \n    // 3. Unisco i frammenti con un doppio ritorno a capo\n    let combinedText = fragments.join('\\n\\n');\n    \n    // 4. Rimozione Tag HTML e Unescape delle entità\n    return combinedText\n      .replace(/<[^>]*>/g, '')      // Rimuove tutti i tag come <b>, <i>, <code>, etc.\n      .replace(/&lt;/g, '<')         // Converte &lt; in <\n      .replace(/&gt;/g, '>')         // Converte &gt; in >\n      .replace(/&amp;/g, '&');       // Converte &amp; in &\n  })()\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "crediti",
              "displayName": "crediti",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "customer_name",
              "displayName": "customer_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "email_sender",
              "displayName": "email_sender",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "control_sheet_id",
              "displayName": "control_sheet_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "lang",
              "displayName": "lang",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "account_status",
              "displayName": "account_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "paid",
              "displayName": "paid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "stripe_customer_id",
              "displayName": "stripe_customer_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "pro",
              "displayName": "pro",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "call_proposal_agent",
              "displayName": "call_proposal_agent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "mail1_example",
              "displayName": "mail1_example",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "case_study",
              "displayName": "case_study",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "wa_outreach",
              "displayName": "wa_outreach",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "wa_followup",
              "displayName": "wa_followup",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "access_token",
              "displayName": "access_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "access_token_timestamp",
              "displayName": "access_token_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "access_token_expires_in",
              "displayName": "access_token_expires_in",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token_timestamp",
              "displayName": "refresh_token_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "refresh_token_expires_in",
              "displayName": "refresh_token_expires_in",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "brevo_api_key",
              "displayName": "brevo_api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "brevo_to_n8n_webhook",
              "displayName": "brevo_to_n8n_webhook",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "tos_and_privacy_accepted",
              "displayName": "tos_and_privacy_accepted",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "tos_approval_timestamp",
              "displayName": "tos_approval_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "privacy_approval_timestamp",
              "displayName": "privacy_approval_timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link",
              "displayName": "payment_link",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_expires_at_unix",
              "displayName": "payment_link_expires_at_unix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_semester",
              "displayName": "payment_link_semester",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_semester_expires_at_unix",
              "displayName": "payment_link_semester_expires_at_unix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_year",
              "displayName": "payment_link_year",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_year_expires_at_unix",
              "displayName": "payment_link_year_expires_at_unix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_id",
              "displayName": "payment_link_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_semester_id",
              "displayName": "payment_link_semester_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "payment_link_year_id",
              "displayName": "payment_link_year_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "msg_del",
              "displayName": "msg_del",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "parent_folder_id",
              "displayName": "parent_folder_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "ready_for_customizing_instructions_for_emails",
              "displayName": "ready_for_customizing_instructions_for_emails",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "credits_spent_lifetime",
              "displayName": "credits_spent_lifetime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "b_t_one",
              "displayName": "b_t_one",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "b_t_two",
              "displayName": "b_t_two",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "b_t_three",
              "displayName": "b_t_three",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "link_item_one",
              "displayName": "link_item_one",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "link_item_two",
              "displayName": "link_item_two",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "link_item_three",
              "displayName": "link_item_three",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_One_ExpiresAtUnix",
              "displayName": "linkItem_One_ExpiresAtUnix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Two_ExpiresAtUnix",
              "displayName": "linkItem_Two_ExpiresAtUnix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Three_ExpiresAtUnix",
              "displayName": "linkItem_Three_ExpiresAtUnix",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_One_Id",
              "displayName": "linkItem_One_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Two_Id",
              "displayName": "linkItem_Two_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "linkItem_Three_Id",
              "displayName": "linkItem_Three_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "current_plan",
              "displayName": "current_plan",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "boss_business_type_and_industry",
              "displayName": "boss_business_type_and_industry",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "boss_business_ups",
              "displayName": "boss_business_ups",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "boss_business_products",
              "displayName": "boss_business_products",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "last_pa_message",
              "displayName": "last_pa_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "product_analyst_summary",
              "displayName": "product_analyst_summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "product_analyst_summary_step_count",
              "displayName": "product_analyst_summary_step_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "modify_products",
              "displayName": "modify_products",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -66096,
        6688
      ],
      "id": "5aef401e-b4cc-4793-a752-cf926e5bd52d",
      "name": "save.Msg",
      "notesInFlow": false,
      "notes": "last_pa_message"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatID }}",
        "text": "={{ $if($json.lang === \"it\", \"Ottimo!\", \"Great!\") }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -65952,
        6464
      ],
      "id": "1c0c93f5-141f-4123-9f90-436d5ac70293",
      "name": "Great, next",
      "webhookId": "fcb04037-c606-4912-8e4a-f2d7617c5876",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "model": "google/gemini-3-flash-preview",
        "options": {
          "maxRetries": 2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -66736,
        6560
      ],
      "id": "d0be5877-6405-468f-bf46-f9ecf3d930a1",
      "name": "gem3",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Router1').first().json.allData[0].chatID }}-ProductAnalysis-TEST-27",
        "collectionName": "Outsmart_ProductAnalyzerAgent",
        "databaseName": "n8n_vp75",
        "contextWindowLength": 3
      },
      "type": "@n8n/n8n-nodes-langchain.memoryMongoDbChat",
      "typeVersion": 1,
      "position": [
        -66832,
        6560
      ],
      "id": "ffaf538d-3288-494a-b5f4-2315680c4747",
      "name": "M-c-bP1",
      "credentials": {
        "mongoDb": {
          "id": "W56eqBk24SA9Mz65",
          "name": "MongoDB info.excelera"
        }
      }
    },
    {
      "parameters": {
        "amount": 0.11
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -72464,
        6720
      ],
      "id": "245a4c1e-5938-4e14-ad8d-88086f6d677a",
      "name": "Wait",
      "webhookId": "012c2956-01c0-458f-bda1-47c0d4e1a79c"
    },
    {
      "parameters": {
        "content": "#### Security and message OR callback distinction",
        "height": 176,
        "width": 528,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -73648,
        7056
      ],
      "typeVersion": 1,
      "id": "06e4d3f8-78ba-4cdd-85ef-5bc6ac48af49",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "j86UAFgr3tmMssExiiTHd",
          "mode": "list",
          "cachedResultUrl": "/workflow/j86UAFgr3tmMssExiiTHd",
          "cachedResultName": "Msg_del Saver"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "include_previous_message": false,
            "chatID": "={{ String($('Webhook').first().json.body.message.chat.id) }}",
            "message_id": "={{ String($('Webhook').first().json.body.message.message_id) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "include_previous_message",
              "displayName": "include_previous_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -71952,
        6592
      ],
      "id": "f319a2f7-7239-4f34-a533-b492b5891975",
      "name": "Save user msg_id1",
      "notesInFlow": true
    },
    {
      "parameters": {
        "description": "Esegue il salvataggio definitivo del DNA commerciale nel database. ATTENZIONE: Questo tool può essere richiamato SOLO E SOLTANTO SE l'ultimo messaggio dell'utente è una conferma breve e atomica (es. 'Sì', 'Ok', 'Procedi') ricevuta DOPO che è stata presentata una bozza finale. È ASSOLUTAMENTE VIETATO invocare questo tool se il messaggio dell'utente contiene nuove istruzioni, domande, o richieste di bozze. **IMPORTANTE**: Questo tool è bloccato da una condizione di sicurezza. Può essere invocato SOLO se l'input dell'utente è una conferma ATOMICA (Sì/Ok) di un testo già presentato nel turno precedente. Se l'utente ha chiesto 'blindature', 'modifiche' o 'nuovi vantaggi', l'uso di questo tool è considerato un ERRORE DI PROTOCOLLO e porterà al fallimento del DNA commerciale.",
        "workflowId": {
          "__rl": true,
          "value": "pVodo9fFEw3UTaCR",
          "mode": "list",
          "cachedResultUrl": "/workflow/pVodo9fFEw3UTaCR",
          "cachedResultName": "Save; Product Analyzer tool"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatID": "={{ $('Router1').first().json.allData[0].chatID }}",
            "products": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('products', `Products and, or, services descriptions`, 'string') }}",
            "type_and_industry": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('type_and_industry', `Type of business and industry keywords`, 'string') }}",
            "ups": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ups', `Unique selling proposition`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "products",
              "displayName": "products",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "type_and_industry",
              "displayName": "type_and_industry",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "ups",
              "displayName": "ups",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -66528,
        6576
      ],
      "id": "54bdd0a3-25ec-4a4d-912f-08219ee1f7ad",
      "name": "Save",
      "notesInFlow": true,
      "notes": "NEW"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "CgZkHNUtHsnejm8I",
          "mode": "list",
          "cachedResultName": "OUTSMART_Temporary Fragments",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/CgZkHNUtHsnejm8I"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message_id": "={{ $('Webhook').first().json.body.message.message_id }}",
            "message_fragment": "={{ $('Webhook').first().json.body.message.text }}",
            "chatID": "={{ $('Webhook').first().json.body.message.chat.id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "message_fragment",
              "displayName": "message_fragment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -72592,
        6720
      ],
      "id": "96341f1d-271f-43bf-8be0-10957598df98",
      "name": "addFragment"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "8Sr0I5aUg6C8zN18",
          "mode": "list",
          "cachedResultName": "Customer_Credentials",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/8Sr0I5aUg6C8zN18"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "chatID",
              "keyValue": "={{ $('Webhook').item.json.body.message.chat.id }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -72880,
        7072
      ],
      "id": "5c53e9ee-5a99-477e-b361-64e1cf989288",
      "name": "Match ID and status"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "CgZkHNUtHsnejm8I",
          "mode": "list",
          "cachedResultName": "OUTSMART_Temporary Fragments",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/CgZkHNUtHsnejm8I"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "chatID",
              "keyValue": "={{ $('addFragment').item.json.chatID }}"
            }
          ]
        },
        "returnAll": true
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -72336,
        6720
      ],
      "id": "c48b5ad3-24eb-455b-9eed-e3a6f3f3782f",
      "name": "getFragments"
    },
    {
      "parameters": {
        "operation": "deleteRows",
        "dataTableId": {
          "__rl": true,
          "value": "CgZkHNUtHsnejm8I",
          "mode": "list",
          "cachedResultName": "OUTSMART_Temporary Fragments",
          "cachedResultUrl": "/projects/4VxCGfA6xewekina/datatables/CgZkHNUtHsnejm8I"
        },
        "matchType": "allConditions",
        "filters": {
          "conditions": [
            {
              "keyName": "chatID",
              "keyValue": "={{ $('getFragments').first().json.chatID }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        -71920,
        6736
      ],
      "id": "02600e13-3482-4700-aa73-1adc8e89c15b",
      "name": "Clean-up"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "id-1",
              "leftValue": "={{ $json.bufferTEXT }}",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "1710b9c2-85a8-468b-becc-21fa9f2624bb",
      "name": "Check if highest ID",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -72064,
        6720
      ]
    },
    {
      "parameters": {
        "jsCode": "const currentMessageId = $('Webhook').first().json.body.message.message_id;\nconst fragments = $('getFragments').all();\n\nif (!fragments || fragments.length === 0) {\n  const bodyMessageText = $('Webhook').first().json.body.message.text;\n  return [{json: {bufferTEXT: bodyMessageText}}];\n}\n\nconst allMessageIds = fragments.map(f => Number(f.json.message_id));\nconst highestMessageId = Math.max(...allMessageIds);\n\nif (currentMessageId < highestMessageId) {\n  return [];\n}\n\nconst sortedFragments = fragments\n  .map(f => ({\n    id: Number(f.json.message_id),\n    text: f.json.message_fragment\n  }))\n  .sort((a, b) => a.id - b.id);\n\nconst concatenatedText = sortedFragments.map(f => f.text).join('\\n');\n\nreturn [{json: {bufferTEXT: concatenatedText}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -72208,
        6720
      ],
      "id": "6a435973-eae0-4053-b68c-17961fa0c8fd",
      "name": "The 'Weaver'",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "content": "### Async Concurrency Mechanism for fragmented Input",
        "height": 352,
        "width": 928,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -72608,
        6544
      ],
      "typeVersion": 1,
      "id": "d11accbe-ee42-40c6-957c-9e040b570c49",
      "name": "Sticky Note37"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n\t\"message\": [\"block 1\", \"block 2\", \"block 3\"]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -66304,
        6464
      ],
      "id": "4cad9368-2246-455a-9a4b-db704b034661",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "dce25b87-ac0f-4053-a327-724f42a2896c",
              "leftValue": "={{ $('Telegram Trigger').item.json.message.text }}",
              "rightValue": "/init_instruct_protocol",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -70640,
        7056
      ],
      "id": "a0a39f14-e65f-4084-93ca-27b965c85053",
      "name": "/init_instruct_protocol?"
    },
    {
      "parameters": {
        "content": "#### Configuration ",
        "height": 192,
        "width": 342,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -72464,
        7040
      ],
      "typeVersion": 1,
      "id": "617b912d-92e7-473d-a69e-c17429cf7963",
      "name": "Sticky Note36"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ \n  $('The \\'Weaver\\'').all().length > 0 \n    ? ({ \n        \"update_id\": $('Webhook').first().json.body.update_id || null, \n        \"message\": { \n          ...$('Webhook').first().json.body.message, \n          text: $('The \\'Weaver\\'').first().json.bufferTEXT \n        } \n      }) \n    : ({ \n        \"update_id\": $('Webhook').first().json.body.update_id || null, \n        \"message\": $('Webhook').first().json.body.message || null \n      }) \n}}",
        "includeOtherFields": true,
        "include": "selected",
        "includeFields": "headers",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -72432,
        7088
      ],
      "id": "bf80414c-37cd-45e2-9730-69b52c9da76c",
      "name": "Telegram Trigger",
      "notesInFlow": true
    },
    {
      "parameters": {
        "mode": "expression",
        "numberOutputs": 3,
        "output": "={{\n// 1. Controllo se l'oggetto json è vuoto/inesistente -> Route 1 (\"no sub found\")\n$('Match ID and status').first().json === null || \n$('Match ID and status').first().json === undefined || \nObject.keys($('Match ID and status').first().json).length === 0 ? 1 :\n\n// 2. Controllo se message.text è vuoto -> Route 2 (\"stop\")\n$('Telegram Trigger').first().json.message.text === \"\" ? 2 :\n\n// 3. Default: tutto il resto va a 0 (\"ok\")\n0\n}}\n"
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -72064,
        7072
      ],
      "id": "5c317bbe-3e1c-4e29-a7a1-eebf03a062db",
      "name": "Switch4",
      "notesInFlow": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bd8b3dd1-4eb3-43ff-95fe-dfd053f8cbb2",
              "name": "noSubMsg_it",
              "value": "={{ $(`Telegram Trigger`).item.json.message.chat.username      ? $(`Telegram Trigger`).item.json.message.chat.username      : (         $(`Telegram Trigger`).item.json.message.chat.first_name          ? $(`Telegram Trigger`).item.json.message.chat.first_name +              (                 $(`Telegram Trigger`).item.json.message.chat.last_name                  ? ' ' + $(`Telegram Trigger`).item.json.message.chat.last_name                  : ''             )         : ''     ) }}, non hai un'iscrizione attiva.",
              "type": "string"
            },
            {
              "id": "1ffe31fb-3cc1-475e-beb7-be9300b98213",
              "name": "noSubMsg_en",
              "value": "={{ $(`Telegram Trigger`).item.json.message.chat.username      ? $(`Telegram Trigger`).item.json.message.chat.username      : (         $(`Telegram Trigger`).item.json.message.chat.first_name          ? $(`Telegram Trigger`).item.json.message.chat.first_name +              (                 $(`Telegram Trigger`).item.json.message.chat.last_name                  ? ' ' + $(`Telegram Trigger`).item.json.message.chat.last_name                  : ''             )         : ''     ) }}, you don't have an active subscription.",
              "type": "string"
            },
            {
              "id": "82e69caf-bf0e-4bd9-abb1-871cba4c3ca5",
              "name": "tosLink",
              "value": "={{ $('Telegram Trigger').item.json.message.from.language_code === 'it'    ? 'https://legal.xlra.it/terms-it.html'    : 'https://legal.xlra.it/terms-en.html'  }}",
              "type": "string"
            },
            {
              "id": "825d2e08-2ccb-4b4a-b4f3-dccf71fcada7",
              "name": "privacyLink",
              "value": "={{ $('Telegram Trigger').item.json.message.from.language_code === 'it'    ? 'https://legal.xlra.it/privacy-it.html'    : 'https://legal.xlra.it/privacy-en.html'  }}",
              "type": "string"
            },
            {
              "id": "2999253f-2046-4e3e-a879-b248fac5f286",
              "name": "tos_acceptance",
              "value": "={{ $('Telegram Trigger').item.json.message.from.language_code == \"it\" ? \"Accetto\" : \"I accept\" }}",
              "type": "string"
            },
            {
              "id": "265c2244-0085-49ce-b769-55247cc0c8a2",
              "name": "debug",
              "value": false,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -72240,
        7088
      ],
      "id": "2c66faeb-672d-4156-bd34-214fa79f9845",
      "name": "Config",
      "notesInFlow": true
    },
    {
      "parameters": {
        "content": "### If the user is still registering we don't subtract any credits for the messages, otherwise we do",
        "height": 240,
        "width": 496,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -68848,
        7008
      ],
      "typeVersion": 1,
      "id": "c7ea7ed6-5dc5-467d-8aa2-4d0aa207e69f",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "### If the execution is internal because the user is still onboarding we don't save the msg id because it does not exist for that specific execution, but we do for all the other ones",
        "height": 256,
        "width": 368,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -70688,
        6928
      ],
      "typeVersion": 1,
      "id": "031c369a-f671-4376-986f-da30471a9ef0",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "#### Search for user, route if it exists, to the concurrency mechanism, otherwise jump to the registration flow",
        "height": 208,
        "width": 342,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -72912,
        6992
      ],
      "typeVersion": 1,
      "id": "d41b0395-8f3a-4652-a2b0-a36f60a7dab7",
      "name": "Sticky Note38"
    },
    {
      "parameters": {
        "content": "#### Callback query' logics",
        "height": 336,
        "width": 790,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -73168,
        7568
      ],
      "typeVersion": 1,
      "id": "818de036-d31b-4ecf-95db-959b83f5fd8b",
      "name": "Sticky Note39"
    },
    {
      "parameters": {
        "content": "#### Telegram Bot Webhook settings",
        "height": 400,
        "width": 374,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -73936,
        7488
      ],
      "typeVersion": 1,
      "id": "2ce732be-f99b-4e49-b6c2-a12384cd1684",
      "name": "Sticky Note40"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        -71808,
        6736
      ],
      "id": "d988b455-4447-4369-85a0-4dd3f8bf9f98",
      "name": "Limit"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Router1').first().json.allData[0].chatID }}-chatAssistant",
        "collectionName": "Outsmart_AssistantChatAgent-Memory",
        "databaseName": "n8n_vp75",
        "contextWindowLength": 9
      },
      "type": "@n8n/n8n-nodes-langchain.memoryMongoDbChat",
      "typeVersion": 1,
      "position": [
        -66464,
        7280
      ],
      "id": "cbb35dc8-b8d4-4484-8eac-fba2b2bd6cd0",
      "name": "Chat",
      "credentials": {
        "mongoDb": {
          "id": "W56eqBk24SA9Mz65",
          "name": "MongoDB info.excelera"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Router1').first().json.allData[0].chatID }}-lead",
        "collectionName": "Outsmart_AssistantLeadAgent-Memory",
        "databaseName": "n8n_vp75",
        "contextWindowLength": 6
      },
      "type": "@n8n/n8n-nodes-langchain.memoryMongoDbChat",
      "typeVersion": 1,
      "position": [
        -66464,
        7408
      ],
      "id": "b4779e61-9b0f-4467-9dfe-a7a0a2236d66",
      "name": "Memory",
      "credentials": {
        "mongoDb": {
          "id": "W56eqBk24SA9Mz65",
          "name": "MongoDB info.excelera"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Router1').first().json.allData[0].chatID }}-settings",
        "collectionName": "Outsmart_AssistantSettingsAgent-Memory",
        "databaseName": "n8n_vp75",
        "contextWindowLength": 3
      },
      "type": "@n8n/n8n-nodes-langchain.memoryMongoDbChat",
      "typeVersion": 1,
      "position": [
        -66464,
        7536
      ],
      "id": "2b045a12-5528-4996-9e0a-37ca17a6e4b3",
      "name": "Settings",
      "credentials": {
        "mongoDb": {
          "id": "W56eqBk24SA9Mz65",
          "name": "MongoDB info.excelera"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Router1').first().json.allData[0].chatID }}-settings",
        "collectionName": "Outsmart_AssistantCustomizationAgent1",
        "databaseName": "n8n_vp75",
        "contextWindowLength": 11
      },
      "type": "@n8n/n8n-nodes-langchain.memoryMongoDbChat",
      "typeVersion": 1,
      "position": [
        -66832,
        7040
      ],
      "id": "bf415b91-5383-4a22-aed6-324f0a6d63be",
      "name": "M-c-1m1",
      "credentials": {
        "mongoDb": {
          "id": "W56eqBk24SA9Mz65",
          "name": "MongoDB info.excelera"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Router1').first().json.allData[0].chatID }}-pay",
        "collectionName": "Outsmart_AssistantPaymentAgent",
        "databaseName": "n8n_vp75",
        "contextWindowLength": 3
      },
      "type": "@n8n/n8n-nodes-langchain.memoryMongoDbChat",
      "typeVersion": 1,
      "position": [
        -66832,
        6320
      ],
      "id": "e7ae6b9d-acdf-4771-9196-73ee5527deca",
      "name": "M-pay",
      "credentials": {
        "mongoDb": {
          "id": "W56eqBk24SA9Mz65",
          "name": "MongoDB info.excelera"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Router1').item.json.allData[0].chatID }}-registration",
        "collectionName": "Outsmart_AssistantRegistrationAgent",
        "databaseName": "n8n_vp75",
        "contextWindowLength": 6
      },
      "type": "@n8n/n8n-nodes-langchain.memoryMongoDbChat",
      "typeVersion": 1,
      "position": [
        -66832,
        6080
      ],
      "id": "48490a4b-b0ab-453c-9f19-07bd0dfb4d38",
      "name": "M-reg",
      "credentials": {
        "mongoDb": {
          "id": "W56eqBk24SA9Mz65",
          "name": "MongoDB info.excelera"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "output.message",
        "options": {
          "destinationFieldName": "output"
        }
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -64560,
        7168
      ],
      "id": "6f294bae-239e-4215-af7d-c1f744b6b4ac",
      "name": "The Splitter"
    },
    {
      "parameters": {
        "errorType": "errorObject",
        "errorObject": "={{ JSON.stringify($json) }}"
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -70896,
        7200
      ],
      "id": "6b2c9df9-b1e7-41f5-b148-0c9fe0481e71",
      "name": "Stop and Error"
    },
    {
      "parameters": {
        "errorMessage": "=EID-{{ $execution.id }}: {{ $json.error }}"
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -64336,
        7664
      ],
      "id": "fd1333c1-04e6-413f-a990-0f62093c6ecf",
      "name": "Stop and Error1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "81784845-a3e6-4016-9675-9db773497bd9",
              "leftValue": "={{ $('WaitMax33m').first().json.headers.state }}",
              "rightValue": "resumeQRu1gvL9zaovFoBl/fd3574",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -71248,
        7168
      ],
      "id": "fd357451-19d6-4425-828d-c7a8e713ede4",
      "name": "acceptedOrNot?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "ecc31fd5-7133-4ffd-9189-c5c7a0aa060d",
              "leftValue": "={{ $json.error }}",
              "rightValue": "tag",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -64512,
        7424
      ],
      "id": "db286a0a-fe0d-472b-923f-0ee22f64129f",
      "name": "If1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "41040ace-a644-4591-ae9c-423367846b1c",
              "name": "output",
              "value": "={{ $json.output }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -64448,
        7168
      ],
      "id": "ab78b7f3-135b-475e-a0af-e9c870ee5a7b",
      "name": "Output"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "text": "={{\n  (function() {\n    // 1. Pulizia dei backslash selvaggi: trasforma \\\\\\\\n o \\\\n in \\n reale\n    let cleanOutput = $json.output.replace(/\\\\\\\\+n/g, '\\n');\n\n    // 2. Controllo ID e modalità Debug\n    const chatId = $(\"Telegram Trigger\").first().json.message.chat.id;\n    const isAuthorized = (chatId === 6076761699 || chatId === 519366205);\n    const debugMode = $('Config').first().json.debug === true;\n\n    // 3. Restituzione dell'output formattato\n    return (isAuthorized && debugMode) ? `<pre>${cleanOutput}</pre>` : cleanOutput;\n  })()\n}}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -63824,
        7184
      ],
      "id": "eec2d36f-785b-4af6-a318-e759a2c1af25",
      "name": "Answer",
      "webhookId": "0afad475-aecb-4ac5-a7d0-8b904ed09221",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -64048,
        7168
      ],
      "id": "985934b6-0a3b-4455-ab6b-06d50e84af83",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').first().json.message.chat.id }}",
        "text": "={{\n  (function() {\n    // 1. Pulizia dei backslash selvaggi: trasforma \\\\\\\\n o \\\\n in \\n reale\n    let cleanOutput = $json.output.replace(/\\\\\\\\+n/g, '\\n');\n\n    // 2. Controllo ID e modalità Debug\n    const chatId = $(\"Telegram Trigger\").first().json.message.chat.id;\n    const isAuthorized = (chatId === 6076761699 || chatId === 519366205);\n    const debugMode = $('Config').first().json.debug === true;\n\n    // 3. Restituzione dell'output formattato\n    return (isAuthorized && debugMode) ? `<pre>${cleanOutput}</pre>` : cleanOutput;\n  })()\n}}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -63712,
        7424
      ],
      "id": "a8f48ed2-08b3-48de-b051-867f3bd02866",
      "name": "Answer3",
      "webhookId": "0afad475-aecb-4ac5-a7d0-8b904ed09221",
      "notesInFlow": true,
      "credentials": {
        "telegramApi": {
          "id": "iUGcLjhaetFOaCij",
          "name": "outReachExperto"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash-lite-preview-09-2025",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -64288,
        7504
      ],
      "id": "c38b2ece-35ba-4bae-97f1-79bde93275eb",
      "name": "Gemini Flash",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "model": "openai/gpt-4.1",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -64032,
        7520
      ],
      "id": "aa854d80-1318-4533-9336-f603569d86c5",
      "name": "GPT 4.1",
      "credentials": {
        "openRouterApi": {
          "id": "qGOl5C9i859rcWZC",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=[Contesto per l'analisi]\n\"Frammento\": \"{{ $('Output').first().json.output }}\"",
        "options": {
          "systemMessage": "=Analizza questo frammento di testo destinato a Telegram che ha causato un errore di parsing. Individua esattamente quale tag HTML è malformata, non chiusa o annidata male. Restituisci un JSON con: { \"error_type\": \"unclosed_tag\" | \"forbidden_tag\" | \"malformed_entities\", \"target_tag\": \"la tag incriminata\", \"context\": \"le 3 parole prima e dopo l'errore\" }"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -64240,
        7408
      ],
      "id": "98c00950-89e5-442b-9bd2-639283027f2a",
      "name": "Tag Issue Seeker"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=[Contesto per l'analisi]\n\"Frammento\": \"{{ $('Output').first().json.output }}\"\n\"Errori da sistemare\": \"{{ $json.output }}\"",
        "options": {
          "systemMessage": "=Analizza questo frammento di testo destinato a Telegram che ha causato un errore di parsing. Individua esattamente quale tag HTML è malformata, non chiusa o annidata male. Restituisci un JSON con: { \"error_type\": \"unclosed_tag\" | \"forbidden_tag\" | \"malformed_entities\", \"target_tag\": \"la tag incriminata\", \"context\": \"le 3 parole prima e dopo l'errore\" }\n````\n////FINE SYSTEM PROMPT\n////INIZIO USER PROMPT\n````\n[Contesto per l'analisi]\n\"Frammento\": \"{{ $('Output').first().json.output }}\"\n````\n\n# Chirurgo\n````\nSei un esperto di Telegram Bot API. Devi riparare il frammento di testo fornito affinché sia compatibile con il parsing HTML di Telegram. REGOLE:\n\n  - Usa solo <code> e <blockquote>.\n\n  - Assicurati che ogni tag sia chiusa entro la fine del testo.\n\n  - Se trovi caratteri <, > o & non usati per le tag, convertili in &lt;, &gt;, &amp;.\n\nNON cambiare il contenuto del testo, intervieni solo sulla sintassi delle tag. Restituisci SOLO il testo riparato."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        -64000,
        7424
      ],
      "id": "411258e6-d2ca-40d1-af42-7fdfcb3307dc",
      "name": "Issue Fixer"
    },
    {
      "parameters": {
        "content": "### Correction",
        "height": 272,
        "width": 832,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -64576,
        7360
      ],
      "typeVersion": 1,
      "id": "b8ab623a-866c-4baf-aa73-2811dd620531",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "description": "=Use this tool to update the global summary field in the database with newer parts\nRemember to always update the step count and compact the whole state into a super dense, information-rich version of it every 5 interactions (so at step 5, step 10, 15, 20, 25, ecc...). Curreent value is {{ $('Match ID and status').first().json.product_analyst_summary_step_count ?? 0 }}\nIf you see an undefined or null value, it means we are at step 1, so set 1.",
        "workflowId": {
          "__rl": true,
          "value": "G5UbhpY9NzoLz2Mj",
          "mode": "list",
          "cachedResultUrl": "/workflow/G5UbhpY9NzoLz2Mj",
          "cachedResultName": "Update; Summarizer tool"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatID": "={{ $('Router1').first().json.allData[0].chatID }}",
            "productSummary": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('productSummary', `Update the global summary by passing as argument of this field the whole text, including what you've read from previous interactions AND the newely summarized interaction`, 'string') }}",
            "stepCount": "={{ Number($('Match ID and status').first().json.product_analyst_summary_step_count ?? 0 + 1) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chatID",
              "displayName": "chatID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "productSummary",
              "displayName": "productSummary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "stepCount",
              "displayName": "stepCount",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        -66528,
        6816
      ],
      "id": "765e4066-efeb-4f94-8b8c-64abb1247b08",
      "name": "Update",
      "notesInFlow": true,
      "notes": "NEW"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "08af4587-d90d-4fc3-9003-7cdb5290d7ed",
              "leftValue": "={{ $json.output }}",
              "rightValue": "\\\\n",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -64240,
        7168
      ],
      "id": "8417c716-901d-4e49-816d-9105345cad4b",
      "name": "If7"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "vp75.app.n8n.cloud",
            "content-length": "655",
            "accept-encoding": "gzip, br",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "91.108.5.43",
            "cf-ew-via": "15",
            "cf-ipcountry": "NL",
            "cf-ray": "9c916fd6f055d5a1-AMS",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "content-type": "application/json",
            "x-forwarded-for": "91.108.5.43, 172.70.47.177",
            "x-forwarded-host": "vp75.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-37-d47f5fc8c-vx8x2",
            "x-is-trusted": "yes",
            "x-real-ip": "91.108.5.43",
            "x-telegram-bot-api-secret-token": "your132a619c8a9w1d1aw53d-secreta123wra1law987h8a-keyawc1aw951iuiyuodrg-hereqyrete2016187c198adw"
          },
          "params": {},
          "query": {},
          "body": {
            "update_id": 381413183,
            "message": {
              "message_id": 1812,
              "from": {
                "id": 519366205,
                "is_bot": false,
                "first_name": "Emanuel",
                "last_name": "Ionewcu",
                "username": "Gionebeatz",
                "language_code": "it"
              },
              "chat": {
                "id": 519366205,
                "first_name": "Emanuel",
                "last_name": "Ionewcu",
                "username": "Gionebeatz",
                "type": "private"
              },
              "date": 1770284327,
              "text": "Tecnicamente si, EA puó mutare tono istantaneamente in base alla situazione e la conoscenza con cui si interfaccia, quindi é scalabile universalmente per qualsiasi prodotto. L'unico limite é quanto valga la pena per l'utente spendere quanto richiedo, perché chiedo tanti soldi, ma questo va al di lá della USP"
            }
          },
          "webhookUrl": "https://vp75.app.n8n.cloud/webhook/34fd1755-39d9-4553-a8b0-9154f3a94443/webhook",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Chat Agent": {
      "main": [
        [
          {
            "node": "Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe": {
      "main": [
        [
          {
            "node": "Text-Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Voice-Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Image-Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Clear all",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "cmd.cs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "cmd.ms",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Text-Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text-Data1": {
      "main": [
        [
          {
            "node": "Router1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Voice-Data": {
      "main": [
        [
          {
            "node": "Get file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get file": {
      "main": [
        [
          {
            "node": "Transcribe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text-Data": {
      "main": [
        [
          {
            "node": "Router1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "lead_expert": {
      "ai_tool": [
        [
          {
            "node": "Chat Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "migrate_leads": {
      "ai_tool": [
        [
          {
            "node": "lead_expert",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Warning": {
      "main": [
        [
          {
            "node": "WaitMax33m",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Report error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "settings": {
      "ai_tool": [
        [
          {
            "node": "Chat Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "o3-mini-high": {
      "ai_languageModel": [
        [
          {
            "node": "settings",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "read_settings": {
      "ai_tool": [
        [
          {
            "node": "settings",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "edit_settings": {
      "ai_tool": [
        [
          {
            "node": "settings",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "o3minihigh": {
      "ai_languageModel": [
        [
          {
            "node": "lead_expert",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "o3minihi": {
      "ai_languageModel": [
        [
          {
            "node": "Chat Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "outreach": {
      "ai_tool": [
        [
          {
            "node": "Chat Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Image-Data": {
      "main": [
        [
          {
            "node": "Get file1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze": {
      "main": [
        [
          {
            "node": "Image-Data2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get file1": {
      "main": [
        [
          {
            "node": "Analyze",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Image-Data2": {
      "main": [
        [
          {
            "node": "Router1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "report_issue": {
      "ai_tool": [
        [
          {
            "node": "Chat Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "report_lack": {
      "ai_tool": [
        [
          {
            "node": "Chat Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "addFragment",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Telegram Trigger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CleanWarning": {
      "main": [
        [
          {
            "node": "acceptedOrNot?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Report error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clean": {
      "main": [
        [
          {
            "node": "Warning",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Report error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contacted_leads": {
      "ai_tool": [
        [
          {
            "node": "lead_expert",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "search_lead": {
      "ai_tool": [
        [
          {
            "node": "lead_expert",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "lead_to_prospect": {
      "ai_tool": [
        [
          {
            "node": "lead_expert",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Payment Agent": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cmd.cs": {
      "main": [
        [
          {
            "node": "Answer1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cmd.ms": {
      "main": [
        [
          {
            "node": "Answer1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "o4mh": {
      "ai_languageModel": [
        [
          {
            "node": "Payment Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "checkout": {
      "ai_tool": [
        [
          {
            "node": "Payment Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Output",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Noop1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save user msg_id": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WaitMax33m": {
      "main": [
        [
          {
            "node": "CleanWarning",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Registration Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Payment Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Product Analyzer Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Customization Agent - 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "register": {
      "ai_tool": [
        [
          {
            "node": "Registration Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "o3-mini": {
      "ai_languageModel": [
        [
          {
            "node": "Registration Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Registration Agent": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "resume": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Report error1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data2": {
      "main": [
        [
          {
            "node": "Set test webhook",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set LIVE webhook",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get webhook info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "resume",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete row(s)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Insert row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "bot_token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Output",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Payment Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "bot_token": {
      "main": [
        [
          {
            "node": "headers'tokenMatches?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageORcallback": {
      "main": [
        [
          {
            "node": "Match ID and status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer1": {
      "main": [
        [
          {
            "node": "Save AI msg_id1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router1": {
      "main": [
        [
          {
            "node": "Typing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Typing": {
      "main": [
        [
          {
            "node": "UserSubPlan?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Output",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Noop2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Customization Agent - 1": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3.7Sonnet": {
      "ai_languageModel": [
        [
          {
            "node": "Customization Agent - 1",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "3.7Sonnet1": {
      "ai_languageModel": [
        [
          {
            "node": "Payment Agent",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "3.5sonn": {
      "ai_languageModel": [
        [
          {
            "node": "Customization Agent - 1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Spend 1 credit": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Chat Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Warning 0 Crediti",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Warning 0 Crediti": {
      "main": [
        [
          {
            "node": "Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer2": {
      "main": [
        [
          {
            "node": "Save AI msg_id1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Totem.p1": {
      "ai_tool": [
        [
          {
            "node": "Customization Agent - 1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "UserSubPlan?": {
      "main": [
        [
          {
            "node": "Spend 1 credit",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3.7Sonnet3": {
      "ai_languageModel": [
        [
          {
            "node": "Product Analyzer Agent",
            "type": "ai_languageModel",
            "index": 1
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "Summarizer",
            "type": "main",
            "index": 0
          },
          {
            "node": "The Splitter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "modify.false",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Product Analyzer Agent": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "oss-120": {
      "ai_languageModel": [
        [
          {
            "node": "Summarizer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "3.7Sonnet4": {
      "ai_languageModel": [
        [
          {
            "node": "Summarizer",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "3.7Sonnet2": {
      "ai_languageModel": [
        [
          {
            "node": "Registration Agent",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "headers'tokenMatches?": {
      "main": [
        [
          {
            "node": "messageORcallback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "modify.false": {
      "main": [
        [
          {
            "node": "Great, next",
            "type": "main",
            "index": 0
          },
          {
            "node": "Summarizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summarizer": {
      "main": [
        [
          {
            "node": "save.Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Great, next": {
      "main": [
        [
          {
            "node": "Customization Agent - 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gem3": {
      "ai_languageModel": [
        [
          {
            "node": "Product Analyzer Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "M-c-bP1": {
      "ai_memory": [
        [
          {
            "node": "Product Analyzer Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "getFragments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save": {
      "ai_tool": [
        [
          {
            "node": "Product Analyzer Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "addFragment": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Match ID and status": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "getFragments": {
      "main": [
        [
          {
            "node": "The 'Weaver'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "The 'Weaver'": {
      "main": [
        [
          {
            "node": "Check if highest ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if highest ID": {
      "main": [
        [
          {
            "node": "Save user msg_id1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Clean-up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clean-up": {
      "main": [
        [
          {
            "node": "Limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Product Analyzer Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "/init_instruct_protocol?": {
      "main": [
        [
          {
            "node": "Save user msg_id",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch4": {
      "main": [
        [
          {
            "node": "/init_instruct_protocol?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Clean",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config": {
      "main": [
        [
          {
            "node": "Switch4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit": {
      "main": [
        [
          {
            "node": "Telegram Trigger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat": {
      "ai_memory": [
        [
          {
            "node": "Chat Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Memory": {
      "ai_memory": [
        [
          {
            "node": "lead_expert",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Settings": {
      "ai_memory": [
        [
          {
            "node": "settings",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "M-c-1m1": {
      "ai_memory": [
        [
          {
            "node": "Customization Agent - 1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "M-pay": {
      "ai_memory": [
        [
          {
            "node": "Payment Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "M-reg": {
      "ai_memory": [
        [
          {
            "node": "Registration Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "The Splitter": {
      "main": [
        [
          {
            "node": "Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Report error": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message": {
      "main": [
        [
          {
            "node": "Stop and Error1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "acceptedOrNot?": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Tag Issue Seeker",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Output": {
      "main": [
        [
          {
            "node": "If7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer": {
      "main": [
        [
          {
            "node": "Save AI msg_id",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Answer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer3": {
      "main": [
        [
          {
            "node": "Save AI msg_id",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save AI msg_id": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Flash": {
      "ai_languageModel": [
        [
          {
            "node": "Tag Issue Seeker",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "GPT 4.1": {
      "ai_languageModel": [
        [
          {
            "node": "Issue Fixer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Tag Issue Seeker": {
      "main": [
        [
          {
            "node": "Issue Fixer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Issue Fixer": {
      "main": [
        [
          {
            "node": "Answer3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update": {
      "ai_tool": [
        [
          {
            "node": "Summarizer",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "If7": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "timeSavedPerExecution": 3
  },
  "versionId": "d43f3931-9e38-44c4-b588-3bf13557cb66",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "877c7cb3d49866a5945e850a30461cea95b771efd663093339d70959d8c23bef"
  },
  "id": "QRu1gvL9zaovFoBl",
  "tags": [
    {
      "updatedAt": "2025-11-09T16:38:31.833Z",
      "createdAt": "2025-11-09T16:38:31.833Z",
      "id": "CsRVszyFvCw0HDgz",
      "name": "outReachExperto"
    },
    {
      "updatedAt": "2025-11-13T14:21:17.778Z",
      "createdAt": "2025-11-13T14:21:17.778Z",
      "id": "zlwAfKXnm74fNqpt",
      "name": "Ea"
    }
  ]
}